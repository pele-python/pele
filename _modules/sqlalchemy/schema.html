

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>sqlalchemy.schema &mdash; pele 0.1 documentation</title>
    
    <link rel="stylesheet" href="../../_static/scipy.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="pele 0.1 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pele 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for sqlalchemy.schema</h1><div class="highlight"><pre>
<span class="c"># sqlalchemy/schema.py</span>
<span class="c"># Copyright (C) 2005-2013 the SQLAlchemy authors and contributors &lt;see AUTHORS file&gt;</span>
<span class="c">#</span>
<span class="c"># This module is part of SQLAlchemy and is released under</span>
<span class="c"># the MIT License: http://www.opensource.org/licenses/mit-license.php</span>

<span class="sd">&quot;&quot;&quot;The schema module provides the building blocks for database metadata.</span>

<span class="sd">Each element within this module describes a database entity which can be</span>
<span class="sd">created and dropped, or is otherwise part of such an entity.  Examples include</span>
<span class="sd">tables, columns, sequences, and indexes.</span>

<span class="sd">All entities are subclasses of :class:`~sqlalchemy.schema.SchemaItem`, and as</span>
<span class="sd">defined in this module they are intended to be agnostic of any vendor-specific</span>
<span class="sd">constructs.</span>

<span class="sd">A collection of entities are grouped into a unit called</span>
<span class="sd">:class:`~sqlalchemy.schema.MetaData`. MetaData serves as a logical grouping of</span>
<span class="sd">schema elements, and can also be associated with an actual database connection</span>
<span class="sd">such that operations involving the contained elements can contact the database</span>
<span class="sd">as needed.</span>

<span class="sd">Two of the elements here also build upon their &quot;syntactic&quot; counterparts, which</span>
<span class="sd">are defined in :class:`~sqlalchemy.sql.expression.`, specifically</span>
<span class="sd">:class:`~sqlalchemy.schema.Table` and :class:`~sqlalchemy.schema.Column`.</span>
<span class="sd">Since these objects are part of the SQL expression language, they are usable</span>
<span class="sd">as components in SQL expressions.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">with_statement</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span><span class="p">,</span> <span class="n">util</span><span class="p">,</span> <span class="n">dialects</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">inspection</span>
<span class="kn">from</span> <span class="nn">.sql</span> <span class="kn">import</span> <span class="n">expression</span><span class="p">,</span> <span class="n">visitors</span>

<span class="n">ddl</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">importlater</span><span class="p">(</span><span class="s">&quot;sqlalchemy.engine&quot;</span><span class="p">,</span> <span class="s">&quot;ddl&quot;</span><span class="p">)</span>
<span class="n">sqlutil</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">importlater</span><span class="p">(</span><span class="s">&quot;sqlalchemy.sql&quot;</span><span class="p">,</span> <span class="s">&quot;util&quot;</span><span class="p">)</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">importlater</span><span class="p">(</span><span class="s">&quot;sqlalchemy.engine&quot;</span><span class="p">,</span> <span class="s">&quot;url&quot;</span><span class="p">)</span>
<span class="n">sqltypes</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">importlater</span><span class="p">(</span><span class="s">&quot;sqlalchemy&quot;</span><span class="p">,</span> <span class="s">&quot;types&quot;</span><span class="p">)</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;SchemaItem&#39;</span><span class="p">,</span> <span class="s">&#39;Table&#39;</span><span class="p">,</span> <span class="s">&#39;Column&#39;</span><span class="p">,</span> <span class="s">&#39;ForeignKey&#39;</span><span class="p">,</span> <span class="s">&#39;Sequence&#39;</span><span class="p">,</span> <span class="s">&#39;Index&#39;</span><span class="p">,</span>
           <span class="s">&#39;ForeignKeyConstraint&#39;</span><span class="p">,</span> <span class="s">&#39;PrimaryKeyConstraint&#39;</span><span class="p">,</span> <span class="s">&#39;CheckConstraint&#39;</span><span class="p">,</span>
           <span class="s">&#39;UniqueConstraint&#39;</span><span class="p">,</span> <span class="s">&#39;DefaultGenerator&#39;</span><span class="p">,</span> <span class="s">&#39;Constraint&#39;</span><span class="p">,</span> <span class="s">&#39;MetaData&#39;</span><span class="p">,</span>
           <span class="s">&#39;ThreadLocalMetaData&#39;</span><span class="p">,</span> <span class="s">&#39;SchemaVisitor&#39;</span><span class="p">,</span> <span class="s">&#39;PassiveDefault&#39;</span><span class="p">,</span>
           <span class="s">&#39;DefaultClause&#39;</span><span class="p">,</span> <span class="s">&#39;FetchedValue&#39;</span><span class="p">,</span> <span class="s">&#39;ColumnDefault&#39;</span><span class="p">,</span> <span class="s">&#39;DDL&#39;</span><span class="p">,</span>
           <span class="s">&#39;CreateTable&#39;</span><span class="p">,</span> <span class="s">&#39;DropTable&#39;</span><span class="p">,</span> <span class="s">&#39;CreateSequence&#39;</span><span class="p">,</span> <span class="s">&#39;DropSequence&#39;</span><span class="p">,</span>
           <span class="s">&#39;AddConstraint&#39;</span><span class="p">,</span> <span class="s">&#39;DropConstraint&#39;</span><span class="p">,</span>
           <span class="p">]</span>
<span class="n">__all__</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>

<span class="n">RETAIN_SCHEMA</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">symbol</span><span class="p">(</span><span class="s">&#39;retain_schema&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">SchemaItem</span><span class="p">(</span><span class="n">events</span><span class="o">.</span><span class="n">SchemaEventTarget</span><span class="p">,</span> <span class="n">visitors</span><span class="o">.</span><span class="n">Visitable</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for items that define a database schema.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;schema_item&#39;</span>
    <span class="n">quote</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_init_items</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialize the list of child items for this SchemaItem.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">item</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">item</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;used to allow SchemaVisitor access&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">generic_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Info dictionary associated with the object, allowing user-defined</span>
<span class="sd">        data to be associated with this :class:`.SchemaItem`.</span>

<span class="sd">        The dictionary is automatically generated when first accessed.</span>
<span class="sd">        It can also be specified in the constructor of some objects,</span>
<span class="sd">        such as :class:`.Table` and :class:`.Column`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">schema</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name</span>


<span class="k">def</span> <span class="nf">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
    <span class="c"># validate remaining kwargs that they all specify DB prefixes</span>

    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s">&#39;^(.+?)_.*&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Additional arguments should be &quot;</span>
                    <span class="s">&quot;named &lt;dialectname&gt;_&lt;argument&gt;, got &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">k</span><span class="p">)</span>


<span class="n">inspection</span><span class="o">.</span><span class="n">_self_inspects</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Table</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">TableClause</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a table in a database.</span>

<span class="sd">    e.g.::</span>

<span class="sd">        mytable = Table(&quot;mytable&quot;, metadata,</span>
<span class="sd">                        Column(&#39;mytable_id&#39;, Integer, primary_key=True),</span>
<span class="sd">                        Column(&#39;value&#39;, String(50))</span>
<span class="sd">                   )</span>

<span class="sd">    The :class:`.Table` object constructs a unique instance of itself based</span>
<span class="sd">    on its name and optional schema name within the given</span>
<span class="sd">    :class:`.MetaData` object. Calling the :class:`.Table`</span>
<span class="sd">    constructor with the same name and same :class:`.MetaData` argument</span>
<span class="sd">    a second time will return the *same* :class:`.Table` object - in this way</span>
<span class="sd">    the :class:`.Table` constructor acts as a registry function.</span>

<span class="sd">    See also:</span>

<span class="sd">    :ref:`metadata_describing` - Introduction to database metadata</span>

<span class="sd">    Constructor arguments are as follows:</span>

<span class="sd">    :param name: The name of this table as represented in the database.</span>

<span class="sd">        This property, along with the *schema*, indicates the *singleton</span>
<span class="sd">        identity* of this table in relation to its parent :class:`.MetaData`.</span>
<span class="sd">        Additional calls to :class:`.Table` with the same name, metadata,</span>
<span class="sd">        and schema name will return the same :class:`.Table` object.</span>

<span class="sd">        Names which contain no upper case characters</span>
<span class="sd">        will be treated as case insensitive names, and will not be quoted</span>
<span class="sd">        unless they are a reserved word.  Names with any number of upper</span>
<span class="sd">        case characters will be quoted and sent exactly.  Note that this</span>
<span class="sd">        behavior applies even for databases which standardize upper</span>
<span class="sd">        case names as case insensitive such as Oracle.</span>

<span class="sd">    :param metadata: a :class:`.MetaData` object which will contain this</span>
<span class="sd">        table.  The metadata is used as a point of association of this table</span>
<span class="sd">        with other tables which are referenced via foreign key.  It also</span>
<span class="sd">        may be used to associate this table with a particular</span>
<span class="sd">        :class:`.Connectable`.</span>

<span class="sd">    :param \*args: Additional positional arguments are used primarily</span>
<span class="sd">        to add the list of :class:`.Column` objects contained within this</span>
<span class="sd">        table. Similar to the style of a CREATE TABLE statement, other</span>
<span class="sd">        :class:`.SchemaItem` constructs may be added here, including</span>
<span class="sd">        :class:`.PrimaryKeyConstraint`, and :class:`.ForeignKeyConstraint`.</span>

<span class="sd">    :param autoload: Defaults to False: the Columns for this table should</span>
<span class="sd">        be reflected from the database. Usually there will be no Column</span>
<span class="sd">        objects in the constructor if this property is set.</span>

<span class="sd">    :param autoload_replace: If ``True``, when using ``autoload=True``</span>
<span class="sd">        and ``extend_existing=True``,</span>
<span class="sd">        replace ``Column`` objects already present in the ``Table`` that&#39;s</span>
<span class="sd">        in the ``MetaData`` registry with</span>
<span class="sd">        what&#39;s reflected.  Otherwise, all existing columns will be</span>
<span class="sd">        excluded from the reflection process.    Note that this does</span>
<span class="sd">        not impact ``Column`` objects specified in the same call to ``Table``</span>
<span class="sd">        which includes ``autoload``, those always take precedence.</span>
<span class="sd">        Defaults to ``True``.</span>

<span class="sd">        .. versionadded:: 0.7.5</span>

<span class="sd">    :param autoload_with: If autoload==True, this is an optional Engine</span>
<span class="sd">        or Connection instance to be used for the table reflection. If</span>
<span class="sd">        ``None``, the underlying MetaData&#39;s bound connectable will be used.</span>

<span class="sd">    :param extend_existing: When ``True``, indicates that if this</span>
<span class="sd">        :class:`.Table` is already present in the given :class:`.MetaData`,</span>
<span class="sd">        apply further arguments within the constructor to the existing</span>
<span class="sd">        :class:`.Table`.</span>

<span class="sd">        If ``extend_existing`` or ``keep_existing`` are not set, an error is</span>
<span class="sd">        raised if additional table modifiers are specified when</span>
<span class="sd">        the given :class:`.Table` is already present in the :class:`.MetaData`.</span>

<span class="sd">        .. versionchanged:: 0.7.4</span>
<span class="sd">            ``extend_existing`` will work in conjunction</span>
<span class="sd">            with ``autoload=True`` to run a new reflection operation against</span>
<span class="sd">            the database; new :class:`.Column` objects will be produced</span>
<span class="sd">            from database metadata to replace those existing with the same</span>
<span class="sd">            name, and additional :class:`.Column` objects not present</span>
<span class="sd">            in the :class:`.Table` will be added.</span>

<span class="sd">        As is always the case with ``autoload=True``, :class:`.Column`</span>
<span class="sd">        objects can be specified in the same :class:`.Table` constructor,</span>
<span class="sd">        which will take precedence.  I.e.::</span>

<span class="sd">            Table(&quot;mytable&quot;, metadata,</span>
<span class="sd">                        Column(&#39;y&#39;, Integer),</span>
<span class="sd">                        extend_existing=True,</span>
<span class="sd">                        autoload=True,</span>
<span class="sd">                        autoload_with=engine</span>
<span class="sd">                    )</span>

<span class="sd">        The above will overwrite all columns within ``mytable`` which</span>
<span class="sd">        are present in the database, except for ``y`` which will be used as is</span>
<span class="sd">        from the above definition.   If the ``autoload_replace`` flag</span>
<span class="sd">        is set to False, no existing columns will be replaced.</span>

<span class="sd">    :param implicit_returning: True by default - indicates that</span>
<span class="sd">        RETURNING can be used by default to fetch newly inserted primary key</span>
<span class="sd">        values, for backends which support this.  Note that</span>
<span class="sd">        create_engine() also provides an implicit_returning flag.</span>

<span class="sd">    :param include_columns: A list of strings indicating a subset of</span>
<span class="sd">        columns to be loaded via the ``autoload`` operation; table columns who</span>
<span class="sd">        aren&#39;t present in this list will not be represented on the resulting</span>
<span class="sd">        ``Table`` object. Defaults to ``None`` which indicates all columns</span>
<span class="sd">        should be reflected.</span>

<span class="sd">    :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">        :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">    :param keep_existing: When ``True``, indicates that if this Table</span>
<span class="sd">        is already present in the given :class:`.MetaData`, ignore</span>
<span class="sd">        further arguments within the constructor to the existing</span>
<span class="sd">        :class:`.Table`, and return the :class:`.Table` object as</span>
<span class="sd">        originally created. This is to allow a function that wishes</span>
<span class="sd">        to define a new :class:`.Table` on first call, but on</span>
<span class="sd">        subsequent calls will return the same :class:`.Table`,</span>
<span class="sd">        without any of the declarations (particularly constraints)</span>
<span class="sd">        being applied a second time. Also see extend_existing.</span>

<span class="sd">        If extend_existing or keep_existing are not set, an error is</span>
<span class="sd">        raised if additional table modifiers are specified when</span>
<span class="sd">        the given :class:`.Table` is already present in the :class:`.MetaData`.</span>

<span class="sd">    :param listeners: A list of tuples of the form ``(&lt;eventname&gt;, &lt;fn&gt;)``</span>
<span class="sd">        which will be passed to :func:`.event.listen` upon construction.</span>
<span class="sd">        This alternate hook to :func:`.event.listen` allows the establishment</span>
<span class="sd">        of a listener function specific to this :class:`.Table` before</span>
<span class="sd">        the &quot;autoload&quot; process begins.  Particularly useful for</span>
<span class="sd">        the :meth:`.DDLEvents.column_reflect` event::</span>

<span class="sd">            def listen_for_reflect(table, column_info):</span>
<span class="sd">                &quot;handle the column reflection event&quot;</span>
<span class="sd">                # ...</span>

<span class="sd">            t = Table(</span>
<span class="sd">                &#39;sometable&#39;,</span>
<span class="sd">                autoload=True,</span>
<span class="sd">                listeners=[</span>
<span class="sd">                    (&#39;column_reflect&#39;, listen_for_reflect)</span>
<span class="sd">                ])</span>

<span class="sd">    :param mustexist: When ``True``, indicates that this Table must already</span>
<span class="sd">        be present in the given :class:`.MetaData` collection, else</span>
<span class="sd">        an exception is raised.</span>

<span class="sd">    :param prefixes:</span>
<span class="sd">        A list of strings to insert after CREATE in the CREATE TABLE</span>
<span class="sd">        statement.  They will be separated by spaces.</span>

<span class="sd">    :param quote: Force quoting of this table&#39;s name on or off, corresponding</span>
<span class="sd">        to ``True`` or ``False``.  When left at its default of ``None``,</span>
<span class="sd">        the column identifier will be quoted according to whether the name is</span>
<span class="sd">        case sensitive (identifiers with at least one upper case character are</span>
<span class="sd">        treated as case sensitive), or if it&#39;s a reserved word.  This flag</span>
<span class="sd">        is only needed to force quoting of a reserved word which is not known</span>
<span class="sd">        by the SQLAlchemy dialect.</span>

<span class="sd">    :param quote_schema: same as &#39;quote&#39; but applies to the schema identifier.</span>

<span class="sd">    :param schema: The *schema name* for this table, which is required if</span>
<span class="sd">        the table resides in a schema other than the default selected schema</span>
<span class="sd">        for the engine&#39;s database connection. Defaults to ``None``.</span>

<span class="sd">    :param useexisting: Deprecated.  Use extend_existing.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;table&#39;</span>

    <span class="k">def</span> <span class="nf">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="c"># python3k pickle seems to call this</span>
            <span class="k">return</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s">&quot;Table() takes at least two arguments&quot;</span><span class="p">)</span>

        <span class="n">schema</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;schema&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">keep_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;keep_existing&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">extend_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;extend_existing&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;useexisting&#39;</span> <span class="ow">in</span> <span class="n">kw</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;useexisting is deprecated.  Use extend_existing.&quot;</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn_deprecated</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extend_existing</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;useexisting is synonymous with extend_existing.&quot;</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="n">extend_existing</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;useexisting&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">keep_existing</span> <span class="ow">and</span> <span class="n">extend_existing</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;keep_existing and extend_existing are mutually exclusive.&quot;</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="n">mustexist</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;mustexist&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_existing</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">extend_existing</span> <span class="ow">and</span> <span class="nb">bool</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39; is already defined for this MetaData &quot;</span>
                    <span class="s">&quot;instance.  Specify &#39;extend_existing=True&#39; &quot;</span>
                    <span class="s">&quot;to redefine &quot;</span>
                    <span class="s">&quot;options and columns on an &quot;</span>
                    <span class="s">&quot;existing Table object.&quot;</span> <span class="o">%</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extend_existing</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">_init_existing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">table</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mustexist</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39; not defined&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="n">table</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="n">cls</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">before_parent_attach</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">_add_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">table</span><span class="o">.</span><span class="n">_init</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
                <span class="n">table</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_parent_attach</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">table</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">metadata</span><span class="o">.</span><span class="n">_remove_table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor for :class:`~.schema.Table`.</span>

<span class="sd">        This method is a no-op.   See the top-level</span>
<span class="sd">        documentation for :class:`~.schema.Table`</span>
<span class="sd">        for constructor arguments.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># __init__ is overridden to prevent __new__ from</span>
        <span class="c"># calling the superclass constructor.</span>

    <span class="k">def</span> <span class="nf">_init</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Table</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;schema&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span>
                <span class="s">&#39;quote_schema&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="o">.</span><span class="n">quote_schema</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;quote_schema&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnCollection</span><span class="p">()</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">()</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">autoload</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload_with&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="c"># this argument is only used with _init_existing()</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload_replace&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">include_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;include_columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">implicit_returning</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;implicit_returning&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;quote&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;info&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s">&#39;listeners&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">listeners</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;listeners&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">evt</span><span class="p">,</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">listeners</span><span class="p">:</span>
                <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">evt</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_prefixes</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;prefixes&#39;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c"># load column definitions from the database if &#39;autoload&#39; is defined</span>
        <span class="c"># we do it after the table is in the singleton dictionary to support</span>
        <span class="c"># circular foreign keys</span>
        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoload</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="p">,</span> <span class="n">include_columns</span><span class="p">)</span>

        <span class="c"># initialize all the column, etc. objects.  done after reflection to</span>
        <span class="c"># allow user-overrides</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_autoload</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="p">,</span> <span class="n">include_columns</span><span class="p">,</span>
                  <span class="n">exclude_columns</span><span class="o">=</span><span class="p">()):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">columns</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">exclude_columns</span>
            <span class="p">])</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autoload_with</span><span class="p">:</span>
            <span class="n">autoload_with</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span>
                <span class="n">autoload_with</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">reflecttable</span><span class="p">,</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">include_columns</span><span class="p">,</span> <span class="n">exclude_columns</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="n">metadata</span><span class="p">,</span>
                    <span class="n">msg</span><span class="o">=</span><span class="s">&quot;No engine is bound to this Table&#39;s MetaData. &quot;</span>
                    <span class="s">&quot;Pass an engine to the Table via &quot;</span>
                    <span class="s">&quot;autoload_with=&lt;someengine&gt;, &quot;</span>
                    <span class="s">&quot;or associate the MetaData with an engine via &quot;</span>
                    <span class="s">&quot;metadata.bind=&lt;someengine&gt;&quot;</span><span class="p">)</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span>
                    <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">reflecttable</span><span class="p">,</span>
                    <span class="bp">self</span><span class="p">,</span> <span class="n">include_columns</span><span class="p">,</span> <span class="n">exclude_columns</span>
                <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_sorted_constraints</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the set of constraints as a list, sorted by creation</span>
<span class="sd">        order.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span><span class="o">.</span><span class="n">_creation_order</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_existing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">autoload</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload_with&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">autoload_replace</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoload_replace&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;schema&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span> <span class="ow">and</span> <span class="n">schema</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Can&#39;t change schema of existing table from &#39;</span><span class="si">%s</span><span class="s">&#39; to &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="n">schema</span><span class="p">))</span>

        <span class="n">include_columns</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;include_columns&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">include_columns</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">include_columns</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;quote&#39;</span><span class="p">,</span> <span class="s">&#39;quote_schema&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>

        <span class="k">if</span> <span class="s">&#39;info&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">autoload_replace</span><span class="p">:</span>
                <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclude_columns</span> <span class="o">=</span> <span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_autoload</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="p">,</span> <span class="n">include_columns</span><span class="p">,</span> <span class="n">exclude_columns</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_kwargs</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extra_kwargs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c"># validate remaining kwargs that they all specify DB prefixes</span>
        <span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="s">&quot;Table&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_init_collections</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">_autoincrement_column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="ow">and</span> \
                <span class="n">col</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_type_affinity</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
                <span class="nb">issubclass</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_type_affinity</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="ow">not</span> <span class="n">col</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">autoincrement</span> <span class="o">==</span> <span class="s">&#39;ignore_fk&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="bp">None</span><span class="p">),</span> <span class="n">Sequence</span><span class="p">))</span> <span class="ow">and</span> \
                <span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">col</span><span class="o">.</span><span class="n">server_default</span><span class="o">.</span><span class="n">reflected</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">col</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;Table(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">)]</span> <span class="o">+</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">+</span>
            <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;schema&#39;</span><span class="p">]])</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the connectable associated with this Table.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span> <span class="ow">or</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">add_is_dependent_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a &#39;dependency&#39; for this Table.</span>

<span class="sd">        This is another Table object which must be created</span>
<span class="sd">        first before this one can, or dropped after this one.</span>

<span class="sd">        Usually, dependencies between tables are determined via</span>
<span class="sd">        ForeignKey objects.   However, for other situations that</span>
<span class="sd">        create dependencies outside of foreign keys (rules, inheriting),</span>
<span class="sd">        this method can manually establish such a link.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_extra_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a :class:`~.schema.Column` to this :class:`~.schema.Table`.</span>

<span class="sd">        The &quot;key&quot; of the newly added :class:`~.schema.Column`, i.e. the</span>
<span class="sd">        value of its ``.key`` attribute, will then be available</span>
<span class="sd">        in the ``.c`` collection of this :class:`~.schema.Table`, and the</span>
<span class="sd">        column definition will be included in any CREATE TABLE, SELECT,</span>
<span class="sd">        UPDATE, etc. statements generated from this :class:`~.schema.Table`</span>
<span class="sd">        construct.</span>

<span class="sd">        Note that this does **not** change the definition of the table</span>
<span class="sd">        as it exists within any underlying database, assuming that</span>
<span class="sd">        table has already been created in the database.   Relational</span>
<span class="sd">        databases support the addition of columns to existing tables</span>
<span class="sd">        using the SQL ALTER command, which would need to be</span>
<span class="sd">        emitted for an already-existing table that doesn&#39;t contain</span>
<span class="sd">        the newly added column.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">column</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_constraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">constraint</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a :class:`~.schema.Constraint` to this</span>
<span class="sd">        :class:`~.schema.Table`.</span>

<span class="sd">        This has the effect of the constraint being included in any</span>
<span class="sd">        future CREATE TABLE statement, assuming specific DDL creation</span>
<span class="sd">        events have not been associated with the given</span>
<span class="sd">        :class:`~.schema.Constraint` object.</span>

<span class="sd">        Note that this does **not** produce the constraint within the</span>
<span class="sd">        relational database automatically, for a table that already exists</span>
<span class="sd">        in the database.   To add a constraint to an</span>
<span class="sd">        existing relational database table, the SQL ALTER command must</span>
<span class="sd">        be used.  SQLAlchemy also provides the</span>
<span class="sd">        :class:`.AddConstraint` construct which can produce this SQL when</span>
<span class="sd">        invoked as an executable clause.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">constraint</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_ddl_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a DDL event listener to this ``Table``.</span>

<span class="sd">        Deprecated.  See :class:`.DDLEvents`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">adapt_listener</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="n">adapt_listener</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="n">metadata</span><span class="o">.</span><span class="n">_add_table</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column_collections</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                                <span class="n">schema_visitor</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">schema_visitor</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">TableClause</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span> <span class="n">column_collections</span><span class="o">=</span><span class="n">column_collections</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">column_collections</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this table exists.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">run_callable</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">has_table</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue a ``CREATE`` statement for this</span>
<span class="sd">        :class:`.Table`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        See also :meth:`.MetaData.create_all`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue a ``DROP`` statement for this</span>
<span class="sd">        :class:`.Table`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        See also :meth:`.MetaData.drop_all`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">tometadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">RETAIN_SCHEMA</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of this :class:`.Table` associated with a different</span>
<span class="sd">        :class:`.MetaData`.</span>

<span class="sd">        E.g.::</span>

<span class="sd">            some_engine = create_engine(&quot;sqlite:///some.db&quot;)</span>

<span class="sd">            # create two metadata</span>
<span class="sd">            meta1 = MetaData()</span>
<span class="sd">            meta2 = MetaData()</span>

<span class="sd">            # load &#39;users&#39; from the sqlite engine</span>
<span class="sd">            users_table = Table(&#39;users&#39;, meta1, autoload=True,</span>
<span class="sd">                                    autoload_with=some_engine)</span>

<span class="sd">            # create the same Table object for the plain metadata</span>
<span class="sd">            users_table_2 = users_table.tometadata(meta2)</span>

<span class="sd">        :param metadata: Target :class:`.MetaData` object.</span>
<span class="sd">        :param schema: Optional string name of a target schema, or</span>
<span class="sd">         ``None`` for no schema.  The :class:`.Table` object will be</span>
<span class="sd">         given this schema name upon copy.   Defaults to the special</span>
<span class="sd">         symbol :attr:`.RETAIN_SCHEMA` which indicates no change should be</span>
<span class="sd">         made to the schema name of the resulting :class:`.Table`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="n">RETAIN_SCHEMA</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>
        <span class="k">elif</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Table &#39;</span><span class="si">%s</span><span class="s">&#39; already exists within the given &quot;</span>
                      <span class="s">&quot;MetaData - not copying.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">))</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span>
            <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append_constraint</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="n">table</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexes</span><span class="p">:</span>
            <span class="c"># skip indexes that would be generated</span>
            <span class="c"># by the &#39;index&#39; flag on Column</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> \
                <span class="nb">list</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">columns</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">Index</span><span class="p">(</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                  <span class="n">unique</span><span class="o">=</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
                  <span class="o">*</span><span class="p">[</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">index</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                  <span class="o">**</span><span class="n">index</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">table</span>


<span class="k">class</span> <span class="nc">Column</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a column in a database table.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;column&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a new ``Column`` object.</span>

<span class="sd">        :param name: The name of this column as represented in the database.</span>
<span class="sd">          This argument may be the first positional argument, or specified</span>
<span class="sd">          via keyword.</span>

<span class="sd">          Names which contain no upper case characters</span>
<span class="sd">          will be treated as case insensitive names, and will not be quoted</span>
<span class="sd">          unless they are a reserved word.  Names with any number of upper</span>
<span class="sd">          case characters will be quoted and sent exactly.  Note that this</span>
<span class="sd">          behavior applies even for databases which standardize upper</span>
<span class="sd">          case names as case insensitive such as Oracle.</span>

<span class="sd">          The name field may be omitted at construction time and applied</span>
<span class="sd">          later, at any time before the Column is associated with a</span>
<span class="sd">          :class:`.Table`.  This is to support convenient</span>
<span class="sd">          usage within the :mod:`~sqlalchemy.ext.declarative` extension.</span>

<span class="sd">        :param type\_: The column&#39;s type, indicated using an instance which</span>
<span class="sd">          subclasses :class:`~sqlalchemy.types.TypeEngine`.  If no arguments</span>
<span class="sd">          are required for the type, the class of the type can be sent</span>
<span class="sd">          as well, e.g.::</span>

<span class="sd">            # use a type with arguments</span>
<span class="sd">            Column(&#39;data&#39;, String(50))</span>

<span class="sd">            # use no arguments</span>
<span class="sd">            Column(&#39;level&#39;, Integer)</span>

<span class="sd">          The ``type`` argument may be the second positional argument</span>
<span class="sd">          or specified by keyword.</span>

<span class="sd">          There is partial support for automatic detection of the</span>
<span class="sd">          type based on that of a :class:`.ForeignKey` associated</span>
<span class="sd">          with this column, if the type is specified as ``None``.</span>
<span class="sd">          However, this feature is not fully implemented and</span>
<span class="sd">          may not function in all cases.</span>

<span class="sd">        :param \*args: Additional positional arguments include various</span>
<span class="sd">          :class:`.SchemaItem` derived constructs which will be applied</span>
<span class="sd">          as options to the column.  These include instances of</span>
<span class="sd">          :class:`.Constraint`, :class:`.ForeignKey`, :class:`.ColumnDefault`,</span>
<span class="sd">          and :class:`.Sequence`.  In some cases an equivalent keyword</span>
<span class="sd">          argument is available such as ``server_default``, ``default``</span>
<span class="sd">          and ``unique``.</span>

<span class="sd">        :param autoincrement: This flag may be set to ``False`` to</span>
<span class="sd">          indicate an integer primary key column that should not be</span>
<span class="sd">          considered to be the &quot;autoincrement&quot; column, that is</span>
<span class="sd">          the integer primary key column which generates values</span>
<span class="sd">          implicitly upon INSERT and whose value is usually returned</span>
<span class="sd">          via the DBAPI cursor.lastrowid attribute.   It defaults</span>
<span class="sd">          to ``True`` to satisfy the common use case of a table</span>
<span class="sd">          with a single integer primary key column.  If the table</span>
<span class="sd">          has a composite primary key consisting of more than one</span>
<span class="sd">          integer column, set this flag to True only on the</span>
<span class="sd">          column that should be considered &quot;autoincrement&quot;.</span>

<span class="sd">          The setting *only* has an effect for columns which are:</span>

<span class="sd">          * Integer derived (i.e. INT, SMALLINT, BIGINT).</span>

<span class="sd">          * Part of the primary key</span>

<span class="sd">          * Are not referenced by any foreign keys, unless</span>
<span class="sd">            the value is specified as ``&#39;ignore_fk&#39;``</span>

<span class="sd">            .. versionadded:: 0.7.4</span>

<span class="sd">          * have no server side or client side defaults (with the exception</span>
<span class="sd">            of Postgresql SERIAL).</span>

<span class="sd">          The setting has these two effects on columns that meet the</span>
<span class="sd">          above criteria:</span>

<span class="sd">          * DDL issued for the column will include database-specific</span>
<span class="sd">            keywords intended to signify this column as an</span>
<span class="sd">            &quot;autoincrement&quot; column, such as AUTO INCREMENT on MySQL,</span>
<span class="sd">            SERIAL on Postgresql, and IDENTITY on MS-SQL.  It does</span>
<span class="sd">            *not* issue AUTOINCREMENT for SQLite since this is a</span>
<span class="sd">            special SQLite flag that is not required for autoincrementing</span>
<span class="sd">            behavior.  See the SQLite dialect documentation for</span>
<span class="sd">            information on SQLite&#39;s AUTOINCREMENT.</span>

<span class="sd">          * The column will be considered to be available as</span>
<span class="sd">            cursor.lastrowid or equivalent, for those dialects which</span>
<span class="sd">            &quot;post fetch&quot; newly inserted identifiers after a row has</span>
<span class="sd">            been inserted (SQLite, MySQL, MS-SQL).  It does not have</span>
<span class="sd">            any effect in this regard for databases that use sequences</span>
<span class="sd">            to generate primary key identifiers (i.e. Firebird, Postgresql,</span>
<span class="sd">            Oracle).</span>

<span class="sd">          .. versionchanged:: 0.7.4</span>
<span class="sd">              ``autoincrement`` accepts a special value ``&#39;ignore_fk&#39;``</span>
<span class="sd">              to indicate that autoincrementing status regardless of foreign</span>
<span class="sd">              key references.  This applies to certain composite foreign key</span>
<span class="sd">              setups, such as the one demonstrated in the ORM documentation</span>
<span class="sd">              at :ref:`post_update`.</span>

<span class="sd">        :param default: A scalar, Python callable, or</span>
<span class="sd">            :class:`.ColumnElement` expression representing the</span>
<span class="sd">            *default value* for this column, which will be invoked upon insert</span>
<span class="sd">            if this column is otherwise not specified in the VALUES clause of</span>
<span class="sd">            the insert. This is a shortcut to using :class:`.ColumnDefault` as</span>
<span class="sd">            a positional argument; see that class for full detail on the</span>
<span class="sd">            structure of the argument.</span>

<span class="sd">            Contrast this argument to ``server_default`` which creates a</span>
<span class="sd">            default generator on the database side.</span>

<span class="sd">        :param doc: optional String that can be used by the ORM or similar</span>
<span class="sd">            to document attributes.   This attribute does not render SQL</span>
<span class="sd">            comments (a future attribute &#39;comment&#39; will achieve that).</span>

<span class="sd">        :param key: An optional string identifier which will identify this</span>
<span class="sd">            ``Column`` object on the :class:`.Table`. When a key is provided,</span>
<span class="sd">            this is the only identifier referencing the ``Column`` within the</span>
<span class="sd">            application, including ORM attribute mapping; the ``name`` field</span>
<span class="sd">            is used only when rendering SQL.</span>

<span class="sd">        :param index: When ``True``, indicates that the column is indexed.</span>
<span class="sd">            This is a shortcut for using a :class:`.Index` construct on the</span>
<span class="sd">            table. To specify indexes with explicit names or indexes that</span>
<span class="sd">            contain multiple columns, use the :class:`.Index` construct</span>
<span class="sd">            instead.</span>

<span class="sd">        :param info: Optional data dictionary which will be populated into the</span>
<span class="sd">            :attr:`.SchemaItem.info` attribute of this object.</span>

<span class="sd">        :param nullable: If set to the default of ``True``, indicates the</span>
<span class="sd">            column will be rendered as allowing NULL, else it&#39;s rendered as</span>
<span class="sd">            NOT NULL. This parameter is only used when issuing CREATE TABLE</span>
<span class="sd">            statements.</span>

<span class="sd">        :param onupdate: A scalar, Python callable, or</span>
<span class="sd">            :class:`~sqlalchemy.sql.expression.ClauseElement` representing a</span>
<span class="sd">            default value to be applied to the column within UPDATE</span>
<span class="sd">            statements, which wil be invoked upon update if this column is not</span>
<span class="sd">            present in the SET clause of the update. This is a shortcut to</span>
<span class="sd">            using :class:`.ColumnDefault` as a positional argument with</span>
<span class="sd">            ``for_update=True``.</span>

<span class="sd">        :param primary_key: If ``True``, marks this column as a primary key</span>
<span class="sd">            column. Multiple columns can have this flag set to specify</span>
<span class="sd">            composite primary keys. As an alternative, the primary key of a</span>
<span class="sd">            :class:`.Table` can be specified via an explicit</span>
<span class="sd">            :class:`.PrimaryKeyConstraint` object.</span>

<span class="sd">        :param server_default: A :class:`.FetchedValue` instance, str, Unicode</span>
<span class="sd">            or :func:`~sqlalchemy.sql.expression.text` construct representing</span>
<span class="sd">            the DDL DEFAULT value for the column.</span>

<span class="sd">            String types will be emitted as-is, surrounded by single quotes::</span>

<span class="sd">                Column(&#39;x&#39;, Text, server_default=&quot;val&quot;)</span>

<span class="sd">                x TEXT DEFAULT &#39;val&#39;</span>

<span class="sd">            A :func:`~sqlalchemy.sql.expression.text` expression will be</span>
<span class="sd">            rendered as-is, without quotes::</span>

<span class="sd">                Column(&#39;y&#39;, DateTime, server_default=text(&#39;NOW()&#39;))0</span>

<span class="sd">                y DATETIME DEFAULT NOW()</span>

<span class="sd">            Strings and text() will be converted into a :class:`.DefaultClause`</span>
<span class="sd">            object upon initialization.</span>

<span class="sd">            Use :class:`.FetchedValue` to indicate that an already-existing</span>
<span class="sd">            column will generate a default value on the database side which</span>
<span class="sd">            will be available to SQLAlchemy for post-fetch after inserts. This</span>
<span class="sd">            construct does not specify any DDL and the implementation is left</span>
<span class="sd">            to the database, such as via a trigger.</span>

<span class="sd">        :param server_onupdate:   A :class:`.FetchedValue` instance</span>
<span class="sd">             representing a database-side default generation function. This</span>
<span class="sd">             indicates to SQLAlchemy that a newly generated value will be</span>
<span class="sd">             available after updates. This construct does not specify any DDL</span>
<span class="sd">             and the implementation is left to the database, such as via a</span>
<span class="sd">             trigger.</span>

<span class="sd">        :param quote: Force quoting of this column&#39;s name on or off,</span>
<span class="sd">             corresponding to ``True`` or ``False``. When left at its default</span>
<span class="sd">             of ``None``, the column identifier will be quoted according to</span>
<span class="sd">             whether the name is case sensitive (identifiers with at least one</span>
<span class="sd">             upper case character are treated as case sensitive), or if it&#39;s a</span>
<span class="sd">             reserved word. This flag is only needed to force quoting of a</span>
<span class="sd">             reserved word which is not known by the SQLAlchemy dialect.</span>

<span class="sd">        :param unique: When ``True``, indicates that this column contains a</span>
<span class="sd">             unique constraint, or if ``index`` is ``True`` as well, indicates</span>
<span class="sd">             that the :class:`.Index` should be created with the unique flag.</span>
<span class="sd">             To specify multiple columns in the constraint/index or to specify</span>
<span class="sd">             an explicit name, use the :class:`.UniqueConstraint` or</span>
<span class="sd">             :class:`.Index` constructs explicitly.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">type_</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;type_&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s">&quot;May not pass name positionally and as a keyword.&quot;</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">coltype</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span>
                 <span class="nb">issubclass</span><span class="p">(</span><span class="n">coltype</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">))):</span>
                <span class="k">if</span> <span class="n">type_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s">&quot;May not pass type_ positionally and as a keyword.&quot;</span><span class="p">)</span>
                <span class="n">type_</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">no_type</span> <span class="o">=</span> <span class="n">type_</span> <span class="ow">is</span> <span class="bp">None</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="n">type_</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;primary_key&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;nullable&#39;</span><span class="p">,</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;server_default&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;server_onupdate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;index&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;unique&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;quote&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;doc&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;onupdate&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">autoincrement</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;autoincrement&#39;</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="c"># check if this Column is proxying another column</span>
        <span class="k">if</span> <span class="s">&#39;_proxies&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_proxies</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;_proxies&#39;</span><span class="p">)</span>
        <span class="c"># otherwise, add DDL-related events</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">SchemaType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&#39;_warn_on_bytestring&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">):</span>
                    <span class="c"># Py3K</span>
                    <span class="c">#if isinstance(self.default, bytes):</span>
                    <span class="c"># Py2K</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="c"># end Py2K</span>
                        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;Unicode column received non-unicode &quot;</span>
                                  <span class="s">&quot;default value.&quot;</span><span class="p">)</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="o">.</span><span class="n">_as_for_update</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span> <span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">)):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="o">.</span><span class="n">_as_for_update</span><span class="p">(</span><span class="bp">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span>
                                            <span class="n">for_update</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_init_items</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="ow">and</span> <span class="n">no_type</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="s">&quot;&#39;type&#39; is required on Column objects &quot;</span>
                                        <span class="s">&quot;which have no foreign keys.&quot;</span><span class="p">)</span>
        <span class="n">util</span><span class="o">.</span><span class="n">set_creation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="s">&#39;info&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">info</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;info&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Unknown arguments passed to Column: &quot;</span> <span class="o">+</span> <span class="nb">repr</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;(no name)&quot;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">named_with_column</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span>

    <span class="k">def</span> <span class="nf">references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if this Column references the given column via foreign</span>
<span class="sd">        key.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">proxy_set</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">column</span><span class="o">.</span><span class="n">proxy_set</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">append_foreign_key</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fk</span><span class="p">):</span>
        <span class="n">fk</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">kwarg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;key&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;primary_key&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;nullable&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;onupdate&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;default&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">:</span>
            <span class="n">kwarg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s">&#39;server_default&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s">&quot;Column(</span><span class="si">%s</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">)]</span> <span class="o">+</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span> <span class="o">+</span>
            <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span> <span class="o">+</span>
            <span class="p">[(</span><span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="s">&quot;table=&lt;</span><span class="si">%s</span><span class="s">&gt;&quot;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span> <span class="ow">or</span> <span class="s">&quot;table=None&quot;</span><span class="p">)]</span> <span class="o">+</span>
            <span class="p">[</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">=</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwarg</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Column must be constructed with a non-blank name or &quot;</span>
                <span class="s">&quot;assign a non-blank .name before adding to a Table.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span>

        <span class="n">existing</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;table&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">existing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Column object already assigned to Table &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                    <span class="n">existing</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="p">:</span>
            <span class="n">col</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">col</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">):</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">fk</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
                        <span class="c"># this might have been removed</span>
                        <span class="c"># already, if it&#39;s a composite constraint</span>
                        <span class="c"># and more than one col being replaced</span>
                        <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fk</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>

        <span class="n">table</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="n">Table</span><span class="o">.</span><span class="n">_autoincrement_column</span><span class="o">.</span><span class="n">_reset</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Trying to redefine primary-key column &#39;</span><span class="si">%s</span><span class="s">&#39; as a &quot;</span>
                <span class="s">&quot;non-primary-key column on table &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">fullname</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;The &#39;index&#39; keyword argument on Column is boolean only. &quot;</span>
                    <span class="s">&quot;To create indexes with a specific name, create an &quot;</span>
                    <span class="s">&quot;explicit Index object external to the Table.&quot;</span><span class="p">)</span>
            <span class="n">Index</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">_truncated_label</span><span class="p">(</span><span class="s">&#39;ix_</span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_label</span><span class="p">),</span>
                                    <span class="bp">self</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;The &#39;unique&#39; keyword argument on Column is boolean &quot;</span>
                    <span class="s">&quot;only. To create unique constraints or indexes with a &quot;</span>
                    <span class="s">&quot;specific name, append an explicit UniqueConstraint to &quot;</span>
                    <span class="s">&quot;the Table&#39;s list of elements, or create an explicit &quot;</span>
                    <span class="s">&quot;Index object external to the Table.&quot;</span><span class="p">)</span>
            <span class="n">table</span><span class="o">.</span><span class="n">append_constraint</span><span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">fn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>
        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;after_parent_attach&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a copy of this ``Column``, unitialized.</span>

<span class="sd">        This is used in ``Table.tometadata``.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c"># Constraint objects plus non-constraint-bound ForeignKey objects</span>
        <span class="n">args</span> <span class="o">=</span> \
            <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">]</span> <span class="o">+</span> \
            <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="o">.</span><span class="n">constraint</span><span class="p">]</span>

        <span class="n">type_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type_</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">SchemaType</span><span class="p">):</span>
            <span class="n">type_</span> <span class="o">=</span> <span class="n">type_</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>

        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">type_</span><span class="o">=</span><span class="n">type_</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
                <span class="n">nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
                <span class="n">unique</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span><span class="p">,</span>
                <span class="n">quote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span>
                <span class="n">index</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                <span class="n">autoincrement</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">autoincrement</span><span class="p">,</span>
                <span class="n">default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
                <span class="n">server_default</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_default</span><span class="p">,</span>
                <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                <span class="n">server_onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">server_onupdate</span><span class="p">,</span>
                <span class="n">info</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">info</span><span class="p">,</span>
                <span class="n">doc</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">doc</span><span class="p">,</span>
                <span class="o">*</span><span class="n">args</span>
                <span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">_make_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selectable</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">name_is_truncatable</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a *proxy* for this column.</span>

<span class="sd">        This is a copy of this ``Column`` referenced by a different parent</span>
<span class="sd">        (such as an alias or select statement).  The column should</span>
<span class="sd">        be used only in select scenarios, as its full DDL/default</span>
<span class="sd">        information is not transferred.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fk</span> <span class="o">=</span> <span class="p">[</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">column</span><span class="p">,</span> <span class="n">_constraint</span><span class="o">=</span><span class="n">f</span><span class="o">.</span><span class="n">constraint</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span><span class="s">&quot;Cannot initialize a sub-selectable&quot;</span>
                    <span class="s">&quot; with this Column object until it&#39;s &#39;name&#39; has &quot;</span>
                    <span class="s">&quot;been assigned.&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_constructor</span><span class="p">(</span>
                <span class="n">expression</span><span class="o">.</span><span class="n">_as_truncated</span><span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">if</span> \
                                <span class="n">name_is_truncatable</span> <span class="k">else</span> <span class="p">(</span><span class="n">name</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                <span class="n">key</span><span class="o">=</span><span class="n">key</span> <span class="k">if</span> <span class="n">key</span> <span class="k">else</span> <span class="n">name</span> <span class="k">if</span> <span class="n">name</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">primary_key</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">,</span>
                <span class="n">nullable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nullable</span><span class="p">,</span>
                <span class="n">quote</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">quote</span><span class="p">,</span>
                <span class="n">_proxies</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="p">],</span> <span class="o">*</span><span class="n">fk</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
            <span class="c"># Py3K</span>
            <span class="c">#raise TypeError(</span>
            <span class="c">#    &quot;Could not create a copy of this %r object.  &quot;</span>
            <span class="c">#    &quot;Ensure the class includes a _constructor() &quot;</span>
            <span class="c">#    &quot;attribute or method which accepts the &quot;</span>
            <span class="c">#    &quot;standard Column constructor arguments, or &quot;</span>
            <span class="c">#    &quot;references the Column class itself.&quot; % self.__class__) from e</span>
            <span class="c"># Py2K</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                <span class="s">&quot;Could not create a copy of this </span><span class="si">%r</span><span class="s"> object.  &quot;</span>
                <span class="s">&quot;Ensure the class includes a _constructor() &quot;</span>
                <span class="s">&quot;attribute or method which accepts the &quot;</span>
                <span class="s">&quot;standard Column constructor arguments, or &quot;</span>
                <span class="s">&quot;references the Column class itself. &quot;</span>
                <span class="s">&quot;Original error: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">,</span> <span class="n">e</span><span class="p">))</span>
            <span class="c"># end Py2K</span>

        <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">selectable</span>
        <span class="n">selectable</span><span class="o">.</span><span class="n">_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">selectable</span><span class="o">.</span><span class="n">_is_clone_of</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">_is_clone_of</span> <span class="o">=</span> <span class="n">selectable</span><span class="o">.</span><span class="n">_is_clone_of</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
            <span class="n">selectable</span><span class="o">.</span><span class="n">primary_key</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">after_parent_attach</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">selectable</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema_visitor</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">schema_visitor</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">]</span> <span class="o">+</span> \
                <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">)</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnClause</span><span class="o">.</span><span class="n">get_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ForeignKey</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Defines a dependency between two columns.</span>

<span class="sd">    ``ForeignKey`` is specified as an argument to a :class:`.Column` object,</span>
<span class="sd">    e.g.::</span>

<span class="sd">        t = Table(&quot;remote_table&quot;, metadata,</span>
<span class="sd">            Column(&quot;remote_id&quot;, ForeignKey(&quot;main_table.id&quot;))</span>
<span class="sd">        )</span>

<span class="sd">    Note that ``ForeignKey`` is only a marker object that defines</span>
<span class="sd">    a dependency between two columns.   The actual constraint</span>
<span class="sd">    is in all cases represented by the :class:`.ForeignKeyConstraint`</span>
<span class="sd">    object.   This object will be generated automatically when</span>
<span class="sd">    a ``ForeignKey`` is associated with a :class:`.Column` which</span>
<span class="sd">    in turn is associated with a :class:`.Table`.   Conversely,</span>
<span class="sd">    when :class:`.ForeignKeyConstraint` is applied to a :class:`.Table`,</span>
<span class="sd">    ``ForeignKey`` markers are automatically generated to be</span>
<span class="sd">    present on each associated :class:`.Column`, which are also</span>
<span class="sd">    associated with the constraint object.</span>

<span class="sd">    Note that you cannot define a &quot;composite&quot; foreign key constraint,</span>
<span class="sd">    that is a constraint between a grouping of multiple parent/child</span>
<span class="sd">    columns, using ``ForeignKey`` objects.   To define this grouping,</span>
<span class="sd">    the :class:`.ForeignKeyConstraint` object must be used, and applied</span>
<span class="sd">    to the :class:`.Table`.   The associated ``ForeignKey`` objects</span>
<span class="sd">    are created automatically.</span>

<span class="sd">    The ``ForeignKey`` objects associated with an individual</span>
<span class="sd">    :class:`.Column` object are available in the `foreign_keys` collection</span>
<span class="sd">    of that column.</span>

<span class="sd">    Further examples of foreign key configuration are in</span>
<span class="sd">    :ref:`metadata_foreignkeys`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;foreign_key&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">_constraint</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_alter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">onupdate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">initially</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">link_to_name</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Construct a column-level FOREIGN KEY.</span>

<span class="sd">        The :class:`.ForeignKey` object when constructed generates a</span>
<span class="sd">        :class:`.ForeignKeyConstraint` which is associated with the parent</span>
<span class="sd">        :class:`.Table` object&#39;s collection of constraints.</span>

<span class="sd">        :param column: A single target column for the key relationship. A</span>
<span class="sd">            :class:`.Column` object or a column name as a string:</span>
<span class="sd">            ``tablename.columnkey`` or ``schema.tablename.columnkey``.</span>
<span class="sd">            ``columnkey`` is the ``key`` which has been assigned to the column</span>
<span class="sd">            (defaults to the column name itself), unless ``link_to_name`` is</span>
<span class="sd">            ``True`` in which case the rendered name of the column is used.</span>

<span class="sd">            .. versionadded:: 0.7.4</span>
<span class="sd">                Note that if the schema name is not included, and the</span>
<span class="sd">                underlying :class:`.MetaData` has a &quot;schema&quot;, that value will</span>
<span class="sd">                be used.</span>

<span class="sd">        :param name: Optional string. An in-database name for the key if</span>
<span class="sd">            `constraint` is not provided.</span>

<span class="sd">        :param onupdate: Optional string. If set, emit ON UPDATE &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">            DELETE and RESTRICT.</span>

<span class="sd">        :param ondelete: Optional string. If set, emit ON DELETE &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">            DELETE and RESTRICT.</span>

<span class="sd">        :param deferrable: Optional bool. If set, emit DEFERRABLE or NOT</span>
<span class="sd">            DEFERRABLE when issuing DDL for this constraint.</span>

<span class="sd">        :param initially: Optional string. If set, emit INITIALLY &lt;value&gt; when</span>
<span class="sd">            issuing DDL for this constraint.</span>

<span class="sd">        :param link_to_name: if True, the string name given in ``column`` is</span>
<span class="sd">            the rendered name of the referenced column, not its locally</span>
<span class="sd">            assigned ``key``.</span>

<span class="sd">        :param use_alter: passed to the underlying</span>
<span class="sd">            :class:`.ForeignKeyConstraint` to indicate the constraint should be</span>
<span class="sd">            generated/dropped externally from the CREATE TABLE/ DROP TABLE</span>
<span class="sd">            statement. See that classes&#39; constructor for details.</span>

<span class="sd">        :param match: Optional string. If set, emit MATCH &lt;value&gt; when issuing</span>
<span class="sd">            DDL for this constraint. Typical values include SIMPLE, PARTIAL</span>
<span class="sd">            and FULL.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span> <span class="o">=</span> <span class="n">column</span>

        <span class="c"># the linked ForeignKeyConstraint.</span>
        <span class="c"># ForeignKey will create this when parent Column</span>
        <span class="c"># is attached to a Table, *or* ForeignKeyConstraint</span>
        <span class="c"># object passes itself in when creating ForeignKey</span>
        <span class="c"># markers.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">_constraint</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span> <span class="o">=</span> <span class="n">use_alter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">onupdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="n">ondelete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span> <span class="o">=</span> <span class="n">deferrable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initially</span> <span class="o">=</span> <span class="n">initially</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span> <span class="o">=</span> <span class="n">link_to_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;ForeignKey(</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produce a copy of this :class:`.ForeignKey` object.</span>

<span class="sd">        The new :class:`.ForeignKey` will not be bound</span>
<span class="sd">        to any :class:`.Column`.</span>

<span class="sd">        This method is usually used by the internal</span>
<span class="sd">        copy procedures of :class:`.Column`, :class:`.Table`,</span>
<span class="sd">        and :class:`.MetaData`.</span>

<span class="sd">        :param schema: The returned :class:`.ForeignKey` will</span>
<span class="sd">          reference the original table and column name, qualified</span>
<span class="sd">          by the given string schema name.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fk</span> <span class="o">=</span> <span class="n">ForeignKey</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">),</span>
                <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
                <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span>
                <span class="p">)</span>
        <span class="n">fk</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fk</span>

    <span class="k">def</span> <span class="nf">_get_colspec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a string based &#39;column specification&#39; for this</span>
<span class="sd">        :class:`.ForeignKey`.</span>

<span class="sd">        This is usually the equivalent of the string-based &quot;tablename.colname&quot;</span>
<span class="sd">        argument first passed to the object&#39;s constructor.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">schema</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> \
                                    <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">key</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="s">&#39;__clause_element__&#39;</span><span class="p">):</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>

        <span class="k">return</span> <span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">_column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">_column</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="n">target_fullname</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_colspec</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return True if the given :class:`.Table` is referenced by this</span>
<span class="sd">        :class:`.ForeignKey`.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">get_referent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the :class:`.Column` in the given :class:`.Table`</span>
<span class="sd">        referenced by this :class:`.ForeignKey`.</span>

<span class="sd">        Returns None if this :class:`.ForeignKey` does not reference the given</span>
<span class="sd">        :class:`.Table`.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">table</span><span class="o">.</span><span class="n">corresponding_column</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">column</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the target :class:`.Column` referenced by this</span>
<span class="sd">        :class:`.ForeignKey`.</span>

<span class="sd">        If this :class:`.ForeignKey` was created using a</span>
<span class="sd">        string-based target column specification, this</span>
<span class="sd">        attribute will on first access initiate a resolution</span>
<span class="sd">        process to locate the referenced remote</span>
<span class="sd">        :class:`.Column`.  The resolution process traverses</span>
<span class="sd">        to the parent :class:`.Column`, :class:`.Table`, and</span>
<span class="sd">        :class:`.MetaData` to proceed - if any of these aren&#39;t</span>
<span class="sd">        yet present, an error is raised.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c"># ForeignKey inits its remote column as late as possible, so tables</span>
        <span class="c"># can be defined without dependencies</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="c"># locate the parent table this foreign key is attached to.  we</span>
            <span class="c"># use the &quot;original&quot; column which our parent column represents</span>
            <span class="c"># (its a list of columns/other ColumnElements if the parent</span>
            <span class="c"># table is a UNION)</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">base_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
                    <span class="n">parenttable</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">table</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Parent column &#39;</span><span class="si">%s</span><span class="s">&#39; does not descend from a &quot;</span>
                    <span class="s">&quot;table-attached Column&quot;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">))</span>

            <span class="n">m</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Invalid foreign key column specification: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">)</span>

            <span class="c"># A FK between column &#39;bar&#39; and table &#39;foo&#39; can be</span>
            <span class="c"># specified as &#39;foo&#39;, &#39;foo.bar&#39;, &#39;dbo.foo.bar&#39;,</span>
            <span class="c"># &#39;otherdb.dbo.foo.bar&#39;. Once we have the column name and</span>
            <span class="c"># the table name, treat everything else as the schema</span>
            <span class="c"># name. Some databases (e.g. Sybase) support</span>
            <span class="c"># inter-database foreign keys. See tickets#1341 and --</span>
            <span class="c"># indirectly related -- Ticket #594. This assumes that &#39;.&#39;</span>
            <span class="c"># will never appear *within* any component of the FK.</span>

            <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">colname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>

            <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="s">&#39;.&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedTableError</span><span class="p">(</span>
                    <span class="s">&quot;Foreign key associated with column &#39;</span><span class="si">%s</span><span class="s">&#39; could not find &quot;</span>
                    <span class="s">&quot;table &#39;</span><span class="si">%s</span><span class="s">&#39; with which to generate a &quot;</span>
                    <span class="s">&quot;foreign key to target column &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">tname</span><span class="p">,</span> <span class="n">colname</span><span class="p">),</span>
                    <span class="n">tname</span><span class="p">)</span>
            <span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
                          <span class="n">mustexist</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span> <span class="s">&#39;_referred_table&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_referred_table</span> <span class="o">=</span> <span class="n">table</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_referred_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&#39;ForeignKeyConstraint on </span><span class="si">%s</span><span class="s">(</span><span class="si">%s</span><span class="s">) refers to &#39;</span>
                    <span class="s">&#39;multiple remote tables: </span><span class="si">%s</span><span class="s"> and </span><span class="si">%s</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">parenttable</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_col_description</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_referred_table</span><span class="p">,</span>
                    <span class="n">table</span>
                <span class="p">))</span>

            <span class="n">_column</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">if</span> <span class="n">colname</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="c"># colname is None in the case that ForeignKey argument</span>
                <span class="c"># was specified as table name only, in which case we</span>
                <span class="c"># match the column name to the same column on the</span>
                <span class="c"># parent.</span>
                <span class="n">key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
                <span class="n">_column</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">colname</span>
                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">colname</span><span class="p">:</span>
                        <span class="n">_column</span> <span class="o">=</span> <span class="n">c</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="n">colname</span>
                <span class="n">_column</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">colname</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_column</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">NoReferencedColumnError</span><span class="p">(</span>
                    <span class="s">&quot;Could not create ForeignKey &#39;</span><span class="si">%s</span><span class="s">&#39; on table &#39;</span><span class="si">%s</span><span class="s">&#39;: &quot;</span>
                    <span class="s">&quot;table &#39;</span><span class="si">%s</span><span class="s">&#39; has no column named &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="n">parenttable</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">),</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>

        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="p">,</span> <span class="s">&#39;__clause_element__&#39;</span><span class="p">):</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">_column</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_colspec</span>

        <span class="c"># propagate TypeEngine to parent if it didn&#39;t have one</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">NullType</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">_column</span><span class="o">.</span><span class="n">type</span>
        <span class="k">return</span> <span class="n">_column</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;parent&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="n">column</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;This ForeignKey already has a parent !&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="c"># standalone ForeignKey - create ForeignKeyConstraint</span>
        <span class="c"># on the hosting Table when attached to the Table.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
                <span class="p">[],</span> <span class="p">[],</span> <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span> <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constraint</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">foreign_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">_NotAColumnExpr</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_not_a_column_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s">&quot;This </span><span class="si">%s</span><span class="s"> cannot be used directly &quot;</span>
                <span class="s">&quot;as a column expression.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="n">__clause_element__</span> <span class="o">=</span> <span class="n">self_group</span> <span class="o">=</span> <span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_not_a_column_expr</span><span class="p">()</span>
    <span class="n">_from_objects</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="k">lambda</span> <span class="bp">self</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_not_a_column_expr</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">DefaultGenerator</span><span class="p">(</span><span class="n">_NotAColumnExpr</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for column *default* values.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;default_generator&#39;</span>

    <span class="n">is_sequence</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">is_server_default</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">column</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">_execute_default</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the connectable associated with this default.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&#39;column&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>


<span class="k">class</span> <span class="nc">ColumnDefault</span><span class="p">(</span><span class="n">DefaultGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A plain default value on a column.</span>

<span class="sd">    This could correspond to a constant, a callable function,</span>
<span class="sd">    or a SQL clause.</span>

<span class="sd">    :class:`.ColumnDefault` is generated automatically</span>
<span class="sd">    whenever the ``default``, ``onupdate`` arguments of</span>
<span class="sd">    :class:`.Column` are used.  A :class:`.ColumnDefault`</span>
<span class="sd">    can be passed positionally as well.</span>

<span class="sd">    For example, the following::</span>

<span class="sd">        Column(&#39;foo&#39;, Integer, default=50)</span>

<span class="sd">    Is equivalent to::</span>

<span class="sd">        Column(&#39;foo&#39;, Integer, ColumnDefault(50))</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;&quot;Construct a new :class:`.ColumnDefault`.</span>


<span class="sd">        :param arg: argument representing the default value.</span>
<span class="sd">         May be one of the following:</span>

<span class="sd">         * a plain non-callable Python value, such as a</span>
<span class="sd">           string, integer, boolean, or other simple type.</span>
<span class="sd">           The default value will be used as is each time.</span>
<span class="sd">         * a SQL expression, that is one which derives from</span>
<span class="sd">           :class:`.ColumnElement`.  The SQL expression will</span>
<span class="sd">           be rendered into the INSERT or UPDATE statement,</span>
<span class="sd">           or in the case of a primary key column when</span>
<span class="sd">           RETURNING is not used may be</span>
<span class="sd">           pre-executed before an INSERT within a SELECT.</span>
<span class="sd">         * A Python callable.  The function will be invoked for each</span>
<span class="sd">           new row subject to an INSERT or UPDATE.</span>
<span class="sd">           The callable must accept exactly</span>
<span class="sd">           zero or one positional arguments.  The one-argument form</span>
<span class="sd">           will receive an instance of the :class:`.ExecutionContext`,</span>
<span class="sd">           which provides contextual information as to the current</span>
<span class="sd">           :class:`.Connection` in use as well as the current</span>
<span class="sd">           statement and parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ColumnDefault</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">FetchedValue</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;ColumnDefault may not be a server-side default type.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
            <span class="n">arg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_maybe_wrap_callable</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">is_clause_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ClauseElement</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">is_scalar</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_callable</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_clause_element</span> <span class="ow">and</span> \
                    <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_sequence</span>

    <span class="k">def</span> <span class="nf">_maybe_wrap_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wrap callables that don&#39;t accept a context.</span>

<span class="sd">        The alternative here is to require that</span>
<span class="sd">        a simple callable passed to &quot;default&quot; would need</span>
<span class="sd">        to be of the form &quot;default=lambda ctx: datetime.now&quot;.</span>
<span class="sd">        That is the more &quot;correct&quot; way to go, but the case</span>
<span class="sd">        of using a zero-arg callable for &quot;default&quot; is so</span>
<span class="sd">        much more prominent than the context-specific one</span>
<span class="sd">        I&#39;m having trouble justifying putting that inconvenience</span>
<span class="sd">        on everyone.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isfunction</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">inspectable</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">elif</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">inspectable</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__init__</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s">&#39;__call__&#39;</span><span class="p">):</span>
            <span class="n">inspectable</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">__call__</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># probably not inspectable, try anyways.</span>
            <span class="n">inspectable</span> <span class="o">=</span> <span class="n">fn</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">argspec</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">getargspec</span><span class="p">(</span><span class="n">inspectable</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">fn</span><span class="p">()</span>

        <span class="n">defaulted</span> <span class="o">=</span> <span class="n">argspec</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="ow">or</span> <span class="mi">0</span>
        <span class="n">positionals</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">argspec</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">defaulted</span>

        <span class="c"># Py3K compat - no unbound methods</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">ismethod</span><span class="p">(</span><span class="n">inspectable</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">fn</span><span class="p">):</span>
            <span class="n">positionals</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">positionals</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="k">lambda</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">fn</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">positionals</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">fn</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;ColumnDefault Python function takes zero or one &quot;</span>
                <span class="s">&quot;positional arguments&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_visit_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;column_onupdate&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;column_default&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_visit_name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;ColumnDefault(</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span>


<span class="k">class</span> <span class="nc">Sequence</span><span class="p">(</span><span class="n">DefaultGenerator</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represents a named database sequence.</span>

<span class="sd">    The :class:`.Sequence` object represents the name and configurational</span>
<span class="sd">    parameters of a database sequence.   It also represents</span>
<span class="sd">    a construct that can be &quot;executed&quot; by a SQLAlchemy :class:`.Engine`</span>
<span class="sd">    or :class:`.Connection`, rendering the appropriate &quot;next value&quot; function</span>
<span class="sd">    for the target database and returning a result.</span>

<span class="sd">    The :class:`.Sequence` is typically associated with a primary key column::</span>

<span class="sd">        some_table = Table(&#39;some_table&#39;, metadata,</span>
<span class="sd">            Column(&#39;id&#39;, Integer, Sequence(&#39;some_table_seq&#39;), primary_key=True)</span>
<span class="sd">        )</span>

<span class="sd">    When CREATE TABLE is emitted for the above :class:`.Table`, if the</span>
<span class="sd">    target platform supports sequences, a CREATE SEQUENCE statement will</span>
<span class="sd">    be emitted as well.   For platforms that don&#39;t support sequences,</span>
<span class="sd">    the :class:`.Sequence` construct is ignored.</span>

<span class="sd">    See also: :class:`.CreateSequence` :class:`.DropSequence`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;sequence&#39;</span>

    <span class="n">is_sequence</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">increment</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">optional</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">quote_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">for_update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a :class:`.Sequence` object.</span>

<span class="sd">        :param name: The name of the sequence.</span>
<span class="sd">        :param start: the starting index of the sequence.  This value is</span>
<span class="sd">         used when the CREATE SEQUENCE command is emitted to the database</span>
<span class="sd">         as the value of the &quot;START WITH&quot; clause.   If ``None``, the</span>
<span class="sd">         clause is omitted, which on most platforms indicates a starting</span>
<span class="sd">         value of 1.</span>
<span class="sd">        :param increment: the increment value of the sequence.  This</span>
<span class="sd">         value is used when the CREATE SEQUENCE command is emitted to</span>
<span class="sd">         the database as the value of the &quot;INCREMENT BY&quot; clause.  If ``None``,</span>
<span class="sd">         the clause is omitted, which on most platforms indicates an</span>
<span class="sd">         increment of 1.</span>
<span class="sd">        :param schema: Optional schema name for the sequence, if located</span>
<span class="sd">         in a schema other than the default.</span>
<span class="sd">        :param optional: boolean value, when ``True``, indicates that this</span>
<span class="sd">         :class:`.Sequence` object only needs to be explicitly generated</span>
<span class="sd">         on backends that don&#39;t provide another way to generate primary</span>
<span class="sd">         key identifiers.  Currently, it essentially means, &quot;don&#39;t create</span>
<span class="sd">         this sequence on the Postgresql backend, where the SERIAL keyword</span>
<span class="sd">         creates a sequence for us automatically&quot;.</span>
<span class="sd">        :param quote: boolean value, when ``True`` or ``False``, explicitly</span>
<span class="sd">         forces quoting of the schema name on or off.  When left at its</span>
<span class="sd">         default of ``None``, normal quoting rules based on casing and reserved</span>
<span class="sd">         words take place.</span>
<span class="sd">        :param metadata: optional :class:`.MetaData` object which will be</span>
<span class="sd">         associated with this :class:`.Sequence`.  A :class:`.Sequence`</span>
<span class="sd">         that is associated with a :class:`.MetaData` gains access to the</span>
<span class="sd">         ``bind`` of that :class:`.MetaData`, meaning the</span>
<span class="sd">         :meth:`.Sequence.create` and :meth:`.Sequence.drop` methods will</span>
<span class="sd">         make usage of that engine automatically.</span>

<span class="sd">         .. versionchanged:: 0.7</span>
<span class="sd">             Additionally, the appropriate CREATE SEQUENCE/</span>
<span class="sd">             DROP SEQUENCE DDL commands will be emitted corresponding to this</span>
<span class="sd">             :class:`.Sequence` when :meth:`.MetaData.create_all` and</span>
<span class="sd">             :meth:`.MetaData.drop_all` are invoked.</span>

<span class="sd">         Note that when a :class:`.Sequence` is applied to a :class:`.Column`,</span>
<span class="sd">         the :class:`.Sequence` is automatically associated with the</span>
<span class="sd">         :class:`.MetaData` object of that column&#39;s parent :class:`.Table`,</span>
<span class="sd">         when that association is made.   The :class:`.Sequence` will then</span>
<span class="sd">         be subject to automatic CREATE SEQUENCE/DROP SEQUENCE corresponding</span>
<span class="sd">         to when the :class:`.Table` object itself is created or dropped,</span>
<span class="sd">         rather than that of the :class:`.MetaData` object overall.</span>
<span class="sd">        :param for_update: Indicates this :class:`.Sequence`, when associated</span>
<span class="sd">         with a :class:`.Column`, should be invoked for UPDATE statements</span>
<span class="sd">         on that column&#39;s table, rather than for INSERT statements, when</span>
<span class="sd">         no value is otherwise present for that column in the statement.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">for_update</span><span class="o">=</span><span class="n">for_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increment</span> <span class="o">=</span> <span class="n">increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">optional</span> <span class="o">=</span> <span class="n">optional</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span>
        <span class="k">if</span> <span class="n">metadata</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">schema</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">quote_schema</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">quote_schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">metadata</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_metadata</span><span class="p">(</span><span class="n">metadata</span><span class="p">)</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">is_callable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="nd">@util.memoized_property</span>
    <span class="k">def</span> <span class="nf">is_clause_element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">next_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a :class:`.next_value` function element</span>
<span class="sd">        which will render the appropriate increment function</span>
<span class="sd">        for this :class:`.Sequence` within any SQL expression.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">expression</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">next_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bind</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">Sequence</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
        <span class="n">column</span><span class="o">.</span><span class="n">_on_table_attach</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_set_table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_metadata</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">_sequences</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">bind</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates this sequence in the database.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drops this sequence from the database.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_not_a_column_expr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                <span class="s">&quot;This </span><span class="si">%s</span><span class="s"> cannot be used directly &quot;</span>
                <span class="s">&quot;as a column expression.  Use func.next_value(sequence) &quot;</span>
                <span class="s">&quot;to produce a &#39;next value&#39; function that&#39;s usable &quot;</span>
                <span class="s">&quot;as a column element.&quot;</span>
                <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">FetchedValue</span><span class="p">(</span><span class="n">_NotAColumnExpr</span><span class="p">,</span> <span class="n">events</span><span class="o">.</span><span class="n">SchemaEventTarget</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A marker for a transparent database-side default.</span>

<span class="sd">    Use :class:`.FetchedValue` when the database is configured</span>
<span class="sd">    to provide some automatic default for a column.</span>

<span class="sd">    E.g.::</span>

<span class="sd">        Column(&#39;foo&#39;, Integer, FetchedValue())</span>

<span class="sd">    Would indicate that some trigger or default generator</span>
<span class="sd">    will create a new value for the ``foo`` column during an</span>
<span class="sd">    INSERT.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`triggered_columns`</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">is_server_default</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="n">reflected</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">has_argument</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>

    <span class="k">def</span> <span class="nf">_as_for_update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">for_update</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clone</span><span class="p">(</span><span class="n">for_update</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_clone</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">for_update</span><span class="p">):</span>
        <span class="n">n</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;column&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="n">n</span><span class="o">.</span><span class="n">for_update</span> <span class="o">=</span> <span class="n">for_update</span>
        <span class="k">return</span> <span class="n">n</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">server_onupdate</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">server_default</span> <span class="o">=</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">generic_repr</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

<span class="n">inspection</span><span class="o">.</span><span class="n">_self_inspects</span><span class="p">(</span><span class="n">FetchedValue</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DefaultClause</span><span class="p">(</span><span class="n">FetchedValue</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A DDL-specified DEFAULT column value.</span>

<span class="sd">    :class:`.DefaultClause` is a :class:`.FetchedValue`</span>
<span class="sd">    that also generates a &quot;DEFAULT&quot; clause when</span>
<span class="sd">    &quot;CREATE TABLE&quot; is emitted.</span>

<span class="sd">    :class:`.DefaultClause` is generated automatically</span>
<span class="sd">    whenever the ``server_default``, ``server_onupdate`` arguments of</span>
<span class="sd">    :class:`.Column` are used.  A :class:`.DefaultClause`</span>
<span class="sd">    can be passed positionally as well.</span>

<span class="sd">    For example, the following::</span>

<span class="sd">        Column(&#39;foo&#39;, Integer, server_default=&quot;50&quot;)</span>

<span class="sd">    Is equivalent to::</span>

<span class="sd">        Column(&#39;foo&#39;, Integer, DefaultClause(&quot;50&quot;))</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">has_argument</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">for_update</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">_reflected</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span>
                                   <span class="n">expression</span><span class="o">.</span><span class="n">ClauseElement</span><span class="p">,</span>
                                   <span class="n">expression</span><span class="o">.</span><span class="n">TextClause</span><span class="p">),</span> <span class="s">&#39;arg&#39;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">for_update</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reflected</span> <span class="o">=</span> <span class="n">_reflected</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;DefaultClause(</span><span class="si">%r</span><span class="s">, for_update=</span><span class="si">%r</span><span class="s">)&quot;</span> <span class="o">%</span> \
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">for_update</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PassiveDefault</span><span class="p">(</span><span class="n">DefaultClause</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A DDL-specified DEFAULT column value.</span>

<span class="sd">    .. deprecated:: 0.6</span>
<span class="sd">        :class:`.PassiveDefault` is deprecated.</span>
<span class="sd">        Use :class:`.DefaultClause`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nd">@util.deprecated</span><span class="p">(</span><span class="s">&quot;0.6&quot;</span><span class="p">,</span>
                <span class="s">&quot;:class:`.PassiveDefault` is deprecated.  &quot;</span>
                <span class="s">&quot;Use :class:`.DefaultClause`.&quot;</span><span class="p">,</span>
                <span class="bp">False</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">DefaultClause</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Constraint</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table-level SQL constraint.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;constraint&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initially</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="n">_create_rule</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a SQL constraint.</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of this ``Constraint``.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        :param _create_rule:</span>
<span class="sd">          a callable which is passed the DDLCompiler object during</span>
<span class="sd">          compilation. Returns True or False to signal inline generation of</span>
<span class="sd">          this Constraint.</span>

<span class="sd">          The AddConstraint and DropConstraint DDL constructs provide</span>
<span class="sd">          DDLElement&#39;s more comprehensive &quot;conditional DDL&quot; approach that is</span>
<span class="sd">          passed a database connection when DDL is being issued. _create_rule</span>
<span class="sd">          is instead called during any CREATE TABLE compilation, where there</span>
<span class="sd">          may not be any transaction/connection in progress. However, it</span>
<span class="sd">          allows conditional compilation of the constraint even for backends</span>
<span class="sd">          which do not support addition of constraints through ALTER TABLE,</span>
<span class="sd">          which currently includes SQLite.</span>

<span class="sd">          _create_rule is used by some types to create constraints.</span>
<span class="sd">          Currently, its call signature is subject to change at any time.</span>

<span class="sd">        :param \**kwargs:</span>
<span class="sd">          Dialect-specific keyword parameters, see the documentation</span>
<span class="sd">          for various dialects and constraints regarding options here.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span> <span class="o">=</span> <span class="n">deferrable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initially</span> <span class="o">=</span> <span class="n">initially</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_create_rule</span> <span class="o">=</span> <span class="n">_create_rule</span>
        <span class="n">util</span><span class="o">.</span><span class="n">set_creation_order</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_validate_dialect_kwargs</span><span class="p">(</span><span class="n">kw</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kw</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">table</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                    <span class="s">&quot;This constraint is not bound to a table.  Did you &quot;</span>
                    <span class="s">&quot;mean to call table.append_constraint(constraint) ?&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span>
        <span class="n">parent</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">ColumnCollectionMixin</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnCollection</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span> <span class="o">=</span> <span class="p">[</span><span class="n">_to_schema_column_or_string</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span> <span class="ow">and</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Column</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pending_colargs</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="n">col</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ColumnCollectionConstraint</span><span class="p">(</span><span class="n">ColumnCollectionMixin</span><span class="p">,</span> <span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A constraint that proxies a ColumnCollection.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param \*columns:</span>
<span class="sd">          A sequence of column names or Column objects.</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of this constraint.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">Constraint</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="n">Constraint</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                              <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">contains_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c"># inlining of</span>
        <span class="c"># return iter(self.columns)</span>
        <span class="c"># ColumnCollection-&gt;OrderedProperties-&gt;OrderedDict</span>
        <span class="n">ordered_dict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">_data</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">ordered_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ordered_dict</span><span class="o">.</span><span class="n">_list</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">_data</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CheckConstraint</span><span class="p">(</span><span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table- or column-level CHECK constraint.</span>

<span class="sd">    Can be included in the definition of a Table or Column.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sqltext</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">initially</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">_create_rule</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                    <span class="n">_autoattach</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a CHECK constraint.</span>

<span class="sd">        :param sqltext:</span>
<span class="sd">          A string containing the constraint definition, which will be used</span>
<span class="sd">          verbatim, or a SQL expression construct.</span>

<span class="sd">        :param name:</span>
<span class="sd">          Optional, the in-database name of the constraint.</span>

<span class="sd">        :param deferrable:</span>
<span class="sd">          Optional bool.  If set, emit DEFERRABLE or NOT DEFERRABLE when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param initially:</span>
<span class="sd">          Optional string.  If set, emit INITIALLY &lt;value&gt; when issuing DDL</span>
<span class="sd">          for this constraint.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">CheckConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deferrable</span><span class="p">,</span> <span class="n">initially</span><span class="p">,</span> <span class="n">_create_rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">_literal_as_text</span><span class="p">(</span><span class="n">sqltext</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">_autoattach</span><span class="p">:</span>
            <span class="n">cols</span> <span class="o">=</span> <span class="n">sqlutil</span><span class="o">.</span><span class="n">find_columns</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span><span class="p">)</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cols</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)])</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span>
                        <span class="n">tables</span><span class="o">.</span><span class="n">pop</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">__visit_name__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parent</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
            <span class="k">return</span> <span class="s">&quot;check_constraint&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s">&quot;column_check_constraint&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">__visit_name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_table</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">target_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">replace</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">col</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">target_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="n">sqltext</span> <span class="o">=</span> <span class="n">visitors</span><span class="o">.</span><span class="n">replacement_traverse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span><span class="p">,</span> <span class="p">{},</span> <span class="n">replace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sqltext</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sqltext</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">CheckConstraint</span><span class="p">(</span><span class="n">sqltext</span><span class="p">,</span>
                                <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                                <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                                <span class="n">_create_rule</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_rule</span><span class="p">,</span>
                                <span class="n">table</span><span class="o">=</span><span class="n">target_table</span><span class="p">,</span>
                                <span class="n">_autoattach</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>


<span class="k">class</span> <span class="nc">ForeignKeyConstraint</span><span class="p">(</span><span class="n">Constraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table-level FOREIGN KEY constraint.</span>

<span class="sd">    Defines a single column or composite FOREIGN KEY ... REFERENCES</span>
<span class="sd">    constraint. For a no-frills, single column foreign key, adding a</span>
<span class="sd">    :class:`.ForeignKey` to the definition of a :class:`.Column` is a shorthand</span>
<span class="sd">    equivalent for an unnamed, single column :class:`.ForeignKeyConstraint`.</span>

<span class="sd">    Examples of foreign key configuration are in :ref:`metadata_foreignkeys`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;foreign_key_constraint&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">columns</span><span class="p">,</span> <span class="n">refcolumns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">ondelete</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">deferrable</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">initially</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">use_alter</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
            <span class="n">link_to_name</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">match</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">table</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a composite-capable FOREIGN KEY.</span>

<span class="sd">        :param columns: A sequence of local column names. The named columns</span>
<span class="sd">          must be defined and present in the parent Table. The names should</span>
<span class="sd">          match the ``key`` given to each column (defaults to the name) unless</span>
<span class="sd">          ``link_to_name`` is True.</span>

<span class="sd">        :param refcolumns: A sequence of foreign column names or Column</span>
<span class="sd">          objects. The columns must all be located within the same Table.</span>

<span class="sd">        :param name: Optional, the in-database name of the key.</span>

<span class="sd">        :param onupdate: Optional string. If set, emit ON UPDATE &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">          DELETE and RESTRICT.</span>

<span class="sd">        :param ondelete: Optional string. If set, emit ON DELETE &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint. Typical values include CASCADE,</span>
<span class="sd">          DELETE and RESTRICT.</span>

<span class="sd">        :param deferrable: Optional bool. If set, emit DEFERRABLE or NOT</span>
<span class="sd">          DEFERRABLE when issuing DDL for this constraint.</span>

<span class="sd">        :param initially: Optional string. If set, emit INITIALLY &lt;value&gt; when</span>
<span class="sd">          issuing DDL for this constraint.</span>

<span class="sd">        :param link_to_name: if True, the string name given in ``column`` is</span>
<span class="sd">          the rendered name of the referenced column, not its locally assigned</span>
<span class="sd">          ``key``.</span>

<span class="sd">        :param use_alter: If True, do not emit the DDL for this constraint as</span>
<span class="sd">          part of the CREATE TABLE definition. Instead, generate it via an</span>
<span class="sd">          ALTER TABLE statement issued after the full collection of tables</span>
<span class="sd">          have been created, and drop it via an ALTER TABLE statement before</span>
<span class="sd">          the full collection of tables are dropped. This is shorthand for the</span>
<span class="sd">          usage of :class:`.AddConstraint` and :class:`.DropConstraint` applied</span>
<span class="sd">          as &quot;after-create&quot; and &quot;before-drop&quot; events on the MetaData object.</span>
<span class="sd">          This is normally used to generate/drop constraints on objects that</span>
<span class="sd">          are mutually dependent on each other.</span>

<span class="sd">        :param match: Optional string. If set, emit MATCH &lt;value&gt; when issuing</span>
<span class="sd">            DDL for this constraint. Typical values include SIMPLE, PARTIAL</span>
<span class="sd">            and FULL.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span>\
                        <span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">deferrable</span><span class="p">,</span> <span class="n">initially</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span> <span class="o">=</span> <span class="n">onupdate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span> <span class="o">=</span> <span class="n">ondelete</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span> <span class="o">=</span> <span class="n">link_to_name</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">use_alter</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="s">&quot;Alterable Constraint requires a name&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span> <span class="o">=</span> <span class="n">use_alter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">match</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>

        <span class="c"># standalone ForeignKeyConstraint - create</span>
        <span class="c"># associated ForeignKey objects which will be applied to hosted</span>
        <span class="c"># Column objects (in col.foreign_keys), either now or when attached</span>
        <span class="c"># to the Table for string-specified names</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">refcol</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">columns</span><span class="p">,</span> <span class="n">refcolumns</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">ForeignKey</span><span class="p">(</span>
                    <span class="n">refcol</span><span class="p">,</span>
                    <span class="n">_constraint</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                    <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                    <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
                    <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
                    <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">columns</span> <span class="ow">and</span> \
            <span class="nb">isinstance</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">Column</span><span class="p">)</span> <span class="ow">and</span> \
            <span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">table</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_col_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">columns</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elements</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ForeignKeyConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">fk</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="c"># string-specified column names now get</span>
            <span class="c"># resolved to Column objects</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">col</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                        <span class="s">&quot;Can&#39;t create ForeignKeyConstraint &quot;</span>
                        <span class="s">&quot;on table &#39;</span><span class="si">%s</span><span class="s">&#39;: no column &quot;</span>
                        <span class="s">&quot;named &#39;</span><span class="si">%s</span><span class="s">&#39; is present.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">,</span> <span class="n">col</span><span class="p">))</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">fk</span><span class="p">,</span> <span class="s">&#39;parent&#39;</span><span class="p">)</span> <span class="ow">or</span> \
                <span class="n">fk</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">col</span><span class="p">:</span>
                <span class="n">fk</span><span class="o">.</span><span class="n">_set_parent_with_dispatch</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">supports_alter</span><span class="p">(</span><span class="n">ddl</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">schema_item</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">table</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">kw</span><span class="p">[</span><span class="s">&#39;tables&#39;</span><span class="p">])</span> <span class="ow">and</span> \
                            <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">supports_alter</span>

            <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&quot;after_create&quot;</span><span class="p">,</span>
                         <span class="n">AddConstraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">supports_alter</span><span class="p">))</span>
            <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s">&quot;before_drop&quot;</span><span class="p">,</span>
                         <span class="n">DropConstraint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">supports_alter</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="n">fkc</span> <span class="o">=</span> <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
                    <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                    <span class="p">[</span><span class="n">x</span><span class="o">.</span><span class="n">_get_colspec</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elements</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span>
                    <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">onupdate</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">onupdate</span><span class="p">,</span>
                    <span class="n">ondelete</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ondelete</span><span class="p">,</span>
                    <span class="n">use_alter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">use_alter</span><span class="p">,</span>
                    <span class="n">deferrable</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">deferrable</span><span class="p">,</span>
                    <span class="n">initially</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">initially</span><span class="p">,</span>
                    <span class="n">link_to_name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">link_to_name</span><span class="p">,</span>
                    <span class="n">match</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">match</span>
                <span class="p">)</span>
        <span class="n">fkc</span><span class="o">.</span><span class="n">dispatch</span><span class="o">.</span><span class="n">_update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dispatch</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">fkc</span>


<span class="k">class</span> <span class="nc">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table-level PRIMARY KEY constraint.</span>

<span class="sd">    Defines a single column or composite PRIMARY KEY constraint. For a</span>
<span class="sd">    no-frills primary key, adding ``primary_key=True`` to one or more</span>
<span class="sd">    ``Column`` definitions is a shorthand equivalent for an unnamed single- or</span>
<span class="sd">    multiple-column PrimaryKeyConstraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;primary_key_constraint&#39;</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">PrimaryKeyConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span> <span class="ow">in</span> <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="p">:</span>
            <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">primary_key</span><span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">table</span><span class="o">.</span><span class="n">constraints</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">c</span><span class="o">.</span><span class="n">primary_key</span> <span class="o">=</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UniqueConstraint</span><span class="p">(</span><span class="n">ColumnCollectionConstraint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table-level UNIQUE constraint.</span>

<span class="sd">    Defines a single column or composite UNIQUE constraint. For a no-frills,</span>
<span class="sd">    single column constraint, adding ``unique=True`` to the ``Column``</span>
<span class="sd">    definition is a shorthand equivalent for an unnamed, single column</span>
<span class="sd">    UniqueConstraint.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;unique_constraint&#39;</span>


<span class="k">class</span> <span class="nc">Index</span><span class="p">(</span><span class="n">ColumnCollectionMixin</span><span class="p">,</span> <span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A table-level INDEX.</span>

<span class="sd">    Defines a composite (one or more column) INDEX. For a no-frills, single</span>
<span class="sd">    column index, adding ``index=True`` to the ``Column`` definition is</span>
<span class="sd">    a shorthand equivalent for an unnamed, single column :class:`.Index`.</span>

<span class="sd">    .. seealso::</span>

<span class="sd">        :ref:`schema_indexes` - General information on :class:`.Index`.</span>

<span class="sd">        :ref:`postgresql_indexes` - PostgreSQL-specific options available for the</span>
<span class="sd">        :class:`.Index` construct.</span>

<span class="sd">        :ref:`mysql_indexes` - MySQL-specific options available for the</span>
<span class="sd">        :class:`.Index` construct.</span>

<span class="sd">        :ref:`mssql_indexes` - MSSQL-specific options available for the</span>
<span class="sd">        :class:`.Index` construct.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;index&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">*</span><span class="n">expressions</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct an index object.</span>

<span class="sd">        :param name:</span>
<span class="sd">          The name of the index</span>

<span class="sd">        :param \*expressions:</span>
<span class="sd">          Column expressions to include in the index.   The expressions</span>
<span class="sd">          are normally instances of :class:`.Column`, but may also</span>
<span class="sd">          be arbitrary SQL expressions which ultmately refer to a</span>
<span class="sd">          :class:`.Column`.</span>

<span class="sd">          .. versionadded:: 0.8 :class:`.Index` supports SQL expressions as</span>
<span class="sd">             well as plain columns.</span>

<span class="sd">        :param unique:</span>
<span class="sd">            Defaults to False: create a unique index.</span>

<span class="sd">        :param \**kw:</span>
<span class="sd">            Other keyword arguments may be interpreted by specific dialects.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="bp">None</span>

        <span class="n">columns</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">expressions</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ClauseElement</span><span class="p">):</span>
                <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cols</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">visitors</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="p">{},</span> <span class="p">{</span><span class="s">&#39;column&#39;</span><span class="p">:</span> <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">cols</span><span class="p">:</span>
                    <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cols</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">columns</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="n">expressions</span>

        <span class="c"># will call _set_parent() if table-bound column</span>
        <span class="c"># objects are present</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">columns</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="o">=</span> <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s">&#39;unique&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kw</span>

    <span class="k">def</span> <span class="nf">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">ColumnCollectionMixin</span><span class="o">.</span><span class="n">_set_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Index &#39;</span><span class="si">%s</span><span class="s">&#39; is against table &#39;</span><span class="si">%s</span><span class="s">&#39;, and &quot;</span>
                <span class="s">&quot;cannot be associated with table &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
                    <span class="n">table</span><span class="o">.</span><span class="n">description</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">table</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;Column &#39;</span><span class="si">%s</span><span class="s">&#39; is not part of table &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span>
                    <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">description</span><span class="p">)</span>
                <span class="p">)</span>
        <span class="n">table</span><span class="o">.</span><span class="n">indexes</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">expressions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">expr</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ClauseElement</span><span class="p">)</span>
            <span class="k">else</span> <span class="n">colexpr</span>
            <span class="k">for</span> <span class="n">expr</span><span class="p">,</span> <span class="n">colexpr</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expressions</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the connectable associated with this Index.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">bind</span>

    <span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue a ``CREATE`` statement for this</span>
<span class="sd">        :class:`.Index`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        See also :meth:`.MetaData.create_all`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Issue a ``DROP`` statement for this</span>
<span class="sd">        :class:`.Index`, using the given :class:`.Connectable`</span>
<span class="sd">        for connectivity.</span>

<span class="sd">        See also :meth:`.MetaData.drop_all`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;Index(</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="s">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span> <span class="o">+</span>
                        <span class="p">[</span><span class="nb">repr</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span> <span class="o">+</span>
                        <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unique</span> <span class="ow">and</span> <span class="p">[</span><span class="s">&quot;unique=True&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="p">[])</span>
                    <span class="p">))</span>


<span class="k">class</span> <span class="nc">MetaData</span><span class="p">(</span><span class="n">SchemaItem</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A collection of :class:`.Table` objects and their associated schema</span>
<span class="sd">    constructs.</span>

<span class="sd">    Holds a collection of :class:`.Table` objects as well as</span>
<span class="sd">    an optional binding to an :class:`.Engine` or</span>
<span class="sd">    :class:`.Connection`.  If bound, the :class:`.Table` objects</span>
<span class="sd">    in the collection and their columns may participate in implicit SQL</span>
<span class="sd">    execution.</span>

<span class="sd">    The :class:`.Table` objects themselves are stored in the</span>
<span class="sd">    ``metadata.tables`` dictionary.</span>

<span class="sd">    The ``bind`` property may be assigned to dynamically.  A common pattern is</span>
<span class="sd">    to start unbound and then bind later when an engine is available::</span>

<span class="sd">      metadata = MetaData()</span>
<span class="sd">      # define tables</span>
<span class="sd">      Table(&#39;mytable&#39;, metadata, ...)</span>
<span class="sd">      # connect to an engine later, perhaps after loading a URL from a</span>
<span class="sd">      # configuration file</span>
<span class="sd">      metadata.bind = an_engine</span>

<span class="sd">    MetaData is a thread-safe object after tables have been explicitly defined</span>
<span class="sd">    or loaded via reflection.</span>

<span class="sd">    See also:</span>

<span class="sd">    :ref:`metadata_describing` - Introduction to database metadata</span>

<span class="sd">    .. index::</span>
<span class="sd">      single: thread safety; MetaData</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;metadata&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">reflect</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                 <span class="n">quote_schema</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new MetaData object.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          An Engine or Connection to bind to.  May also be a string or URL</span>
<span class="sd">          instance, these are passed to create_engine() and this MetaData will</span>
<span class="sd">          be bound to the resulting engine.</span>

<span class="sd">        :param reflect:</span>
<span class="sd">          Optional, automatically load all tables from the bound database.</span>
<span class="sd">          Defaults to False. ``bind`` is required when this option is set.</span>

<span class="sd">          .. deprecated:: 0.8</span>
<span class="sd">                Please use the :meth:`.MetaData.reflect` method.</span>

<span class="sd">        :param schema:</span>
<span class="sd">           The default schema to use for the :class:`.Table`,</span>
<span class="sd">           :class:`.Sequence`, and other objects associated with this</span>
<span class="sd">           :class:`.MetaData`. Defaults to ``None``.</span>

<span class="sd">        :param quote_schema:</span>
<span class="sd">            Sets the ``quote_schema`` flag for those :class:`.Table`,</span>
<span class="sd">            :class:`.Sequence`, and other objects which make usage of the</span>
<span class="sd">            local ``schema`` name.</span>

<span class="sd">        .. versionadded:: 0.7.4</span>
<span class="sd">            ``schema`` and ``quote_schema`` parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">quote_schema</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>
        <span class="k">if</span> <span class="n">reflect</span><span class="p">:</span>
            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s">&quot;reflect=True is deprecate; please &quot;</span>
                            <span class="s">&quot;use the reflect() method.&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">bind</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                    <span class="s">&quot;A bind must be supplied in conjunction &quot;</span>
                    <span class="s">&quot;with reflect=True&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reflect</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;MetaData(bind=</span><span class="si">%r</span><span class="s">)&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">bind</span>

    <span class="k">def</span> <span class="nf">__contains__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table_or_key</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_or_key</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="n">table_or_key</span> <span class="o">=</span> <span class="n">table_or_key</span><span class="o">.</span><span class="n">key</span>
        <span class="k">return</span> <span class="n">table_or_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span>

    <span class="k">def</span> <span class="nf">_add_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">schema</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_remove_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">_get_table_key</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
        <span class="nb">dict</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">t</span><span class="o">.</span><span class="n">schema</span>
                                <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">values</span><span class="p">()</span>
                                <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&#39;tables&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">,</span>
                <span class="s">&#39;schema&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span><span class="p">,</span>
                <span class="s">&#39;quote_schema&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span><span class="p">,</span>
                <span class="s">&#39;schemas&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="p">,</span>
                <span class="s">&#39;sequences&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tables</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;tables&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">schema</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;schema&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quote_schema</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;quote_schema&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sequences</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;sequences&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span> <span class="o">=</span> <span class="n">state</span><span class="p">[</span><span class="s">&#39;schemas&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">is_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if this MetaData is bound to an Engine or Connection.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;An :class:`.Engine` or :class:`.Connection` to which this</span>
<span class="sd">        :class:`.MetaData` is bound.</span>

<span class="sd">        Typically, a :class:`.Engine` is assigned to this attribute</span>
<span class="sd">        so that &quot;implicit execution&quot; may be used, or alternatively</span>
<span class="sd">        as a means of providing engine binding information to an</span>
<span class="sd">        ORM :class:`.Session` object::</span>

<span class="sd">            engine = create_engine(&quot;someurl://&quot;)</span>
<span class="sd">            metadata.bind = engine</span>

<span class="sd">        .. seealso::</span>

<span class="sd">           :ref:`dbengine_implicit` - background on &quot;bound metadata&quot;</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span>

    <span class="k">def</span> <span class="nf">_bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind this MetaData to an Engine, Connection, string or URL.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">)):</span>
            <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">bind</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">_bind_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all Table objects from this MetaData.&quot;&quot;&quot;</span>

        <span class="nb">dict</span><span class="o">.</span><span class="n">clear</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_schemas</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">remove</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove the given Table object from this MetaData.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_remove_table</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">sorted_tables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a list of :class:`.Table` objects sorted in order of</span>
<span class="sd">        foreign key dependency.</span>

<span class="sd">        The sorting will place :class:`.Table` objects that have dependencies</span>
<span class="sd">        first, before the dependencies themselves, representing the</span>
<span class="sd">        order in which they can be created.   To get the order in which</span>
<span class="sd">        the tables would be dropped, use the ``reversed()`` Python built-in.</span>

<span class="sd">        .. seealso::</span>

<span class="sd">            :meth:`.Inspector.sorted_tables`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">sqlutil</span><span class="o">.</span><span class="n">sort_tables</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">reflect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">views</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">only</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Load all available table definitions from the database.</span>

<span class="sd">        Automatically creates ``Table`` entries in this ``MetaData`` for any</span>
<span class="sd">        table available in the database but not yet present in the</span>
<span class="sd">        ``MetaData``.  May be called multiple times to pick up tables recently</span>
<span class="sd">        added to the database, however no special action is taken if a table</span>
<span class="sd">        in this ``MetaData`` no longer exists in the database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the database; if None, uses</span>
<span class="sd">          the existing bind on this ``MetaData``, if any.</span>

<span class="sd">        :param schema:</span>
<span class="sd">          Optional, query and reflect tables from an alterate schema.</span>
<span class="sd">          If None, the schema associated with this :class:`.MetaData`</span>
<span class="sd">          is used, if any.</span>

<span class="sd">        :param views:</span>
<span class="sd">          If True, also reflect views.</span>

<span class="sd">        :param only:</span>
<span class="sd">          Optional.  Load only a sub-set of available named tables.  May be</span>
<span class="sd">          specified as a sequence of names or a callable.</span>

<span class="sd">          If a sequence of names is provided, only those tables will be</span>
<span class="sd">          reflected.  An error is raised if a table is requested but not</span>
<span class="sd">          available.  Named tables already present in this ``MetaData`` are</span>
<span class="sd">          ignored.</span>

<span class="sd">          If a callable is provided, it will be used as a boolean predicate to</span>
<span class="sd">          filter the list of potential table names.  The callable is called</span>
<span class="sd">          with a table name and this ``MetaData`` instance as positional</span>
<span class="sd">          arguments and should return a true value for any table to reflect.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">bind</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>

            <span class="n">reflect_opts</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s">&#39;autoload&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">,</span>
                <span class="s">&#39;autoload_with&#39;</span><span class="p">:</span> <span class="n">conn</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">schema</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">schema</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">reflect_opts</span><span class="p">[</span><span class="s">&#39;schema&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span>

            <span class="n">available</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">table_names</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span>
                                                            <span class="n">connection</span><span class="o">=</span><span class="n">conn</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">views</span><span class="p">:</span>
                <span class="n">available</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                    <span class="n">bind</span><span class="o">.</span><span class="n">dialect</span><span class="o">.</span><span class="n">get_view_names</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">schema</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">schema</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">available_w_schema</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">([</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">.</span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
                                        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">available</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">available_w_schema</span> <span class="o">=</span> <span class="n">available</span>

            <span class="n">current</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tables</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">only</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schname</span> <span class="ow">in</span>
                            <span class="nb">zip</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">available_w_schema</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">schname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="n">only</span><span class="p">):</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">schname</span> <span class="ow">in</span>
                            <span class="nb">zip</span><span class="p">(</span><span class="n">available</span><span class="p">,</span> <span class="n">available_w_schema</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">schname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span> <span class="ow">and</span> <span class="n">only</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">)]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">missing</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">only</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">available</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">schema</span> <span class="ow">and</span> <span class="p">(</span><span class="s">&quot; schema &#39;</span><span class="si">%s</span><span class="s">&#39;&quot;</span> <span class="o">%</span> <span class="n">schema</span><span class="p">)</span> <span class="ow">or</span> <span class="s">&#39;&#39;</span>
                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
                        <span class="s">&#39;Could not reflect: requested table(s) not available &#39;</span>
                        <span class="s">&#39;in </span><span class="si">%s%s</span><span class="s">: (</span><span class="si">%s</span><span class="s">)&#39;</span> <span class="o">%</span>
                        <span class="p">(</span><span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">url</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)))</span>
                <span class="n">load</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">only</span> <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">load</span><span class="p">:</span>
                <span class="n">Table</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">reflect_opts</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">append_ddl_listener</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">listener</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Append a DDL event listener to this ``MetaData``.</span>

<span class="sd">        Deprecated.  See :class:`.DDLEvents`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">adapt_listener</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="n">tables</span> <span class="o">=</span> <span class="n">kw</span><span class="p">[</span><span class="s">&#39;tables&#39;</span><span class="p">]</span>
            <span class="n">listener</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">)</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="n">adapt_listener</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create all tables stored in this metadata.</span>

<span class="sd">        Conditional by default, will not attempt to recreate tables already</span>
<span class="sd">        present in the target database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the</span>
<span class="sd">          database; if None, uses the existing bind on this ``MetaData``, if</span>
<span class="sd">          any.</span>

<span class="sd">        :param tables:</span>
<span class="sd">          Optional list of ``Table`` objects, which is a subset of the total</span>
<span class="sd">          tables in the ``MetaData`` (others are ignored).</span>

<span class="sd">        :param checkfirst:</span>
<span class="sd">          Defaults to True, don&#39;t issue CREATEs for tables already present</span>
<span class="sd">          in the target database.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaGenerator</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">,</span>
                            <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">drop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">tables</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">checkfirst</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Drop all tables stored in this metadata.</span>

<span class="sd">        Conditional by default, will not attempt to drop tables not present in</span>
<span class="sd">        the target database.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          A :class:`.Connectable` used to access the</span>
<span class="sd">          database; if None, uses the existing bind on this ``MetaData``, if</span>
<span class="sd">          any.</span>

<span class="sd">        :param tables:</span>
<span class="sd">          Optional list of ``Table`` objects, which is a subset of the</span>
<span class="sd">          total tables in the ``MetaData`` (others are ignored).</span>

<span class="sd">        :param checkfirst:</span>
<span class="sd">          Defaults to True, only issue DROPs for tables confirmed to be</span>
<span class="sd">          present in the target database.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">bind</span><span class="o">.</span><span class="n">_run_visitor</span><span class="p">(</span><span class="n">ddl</span><span class="o">.</span><span class="n">SchemaDropper</span><span class="p">,</span>
                            <span class="bp">self</span><span class="p">,</span>
                            <span class="n">checkfirst</span><span class="o">=</span><span class="n">checkfirst</span><span class="p">,</span>
                            <span class="n">tables</span><span class="o">=</span><span class="n">tables</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ThreadLocalMetaData</span><span class="p">(</span><span class="n">MetaData</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A MetaData variant that presents a different ``bind`` in every thread.</span>

<span class="sd">    Makes the ``bind`` property of the MetaData a thread-local value, allowing</span>
<span class="sd">    this collection of tables to be bound to different ``Engine``</span>
<span class="sd">    implementations or connections in each thread.</span>

<span class="sd">    The ThreadLocalMetaData starts off bound to None in each thread.  Binds</span>
<span class="sd">    must be made explicitly by assigning to the ``bind`` property or using</span>
<span class="sd">    ``connect()``.  You can also re-bind dynamically multiple times per</span>
<span class="sd">    thread, just like a regular ``MetaData``.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;metadata&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Construct a ThreadLocalMetaData.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">threading</span><span class="o">.</span><span class="n">local</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ThreadLocalMetaData</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The bound Engine or Connection for this thread.</span>

<span class="sd">        This property may be assigned an Engine or Connection, or assigned a</span>
<span class="sd">        string or URL to automatically create a basic Engine for this bind</span>
<span class="sd">        with ``create_engine()``.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_engine&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_bind_to</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Bind to a Connectable in the caller&#39;s thread.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">url</span><span class="o">.</span><span class="n">URL</span><span class="p">)):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">bind</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c"># TODO: this is squirrely.  we shouldnt have to hold onto engines</span>
            <span class="c"># in a case like this</span>
            <span class="k">if</span> <span class="n">bind</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="p">[</span><span class="n">bind</span><span class="p">]</span> <span class="o">=</span> <span class="n">bind</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="o">=</span> <span class="n">bind</span>

    <span class="n">bind</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">_bind_to</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if there is a bind for this thread.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="p">,</span> <span class="s">&#39;_engine&#39;</span><span class="p">)</span> <span class="ow">and</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">_engine</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Dispose all bound engines, in all thread contexts.&quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__engines</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="s">&#39;dispose&#39;</span><span class="p">):</span>
                <span class="n">e</span><span class="o">.</span><span class="n">dispose</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">SchemaVisitor</span><span class="p">(</span><span class="n">visitors</span><span class="o">.</span><span class="n">ClauseVisitor</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Define the visiting for ``SchemaItem`` objects.&quot;&quot;&quot;</span>

    <span class="n">__traverse_options__</span> <span class="o">=</span> <span class="p">{</span><span class="s">&#39;schema_visitor&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">}</span>


<span class="k">class</span> <span class="nc">_DDLCompiles</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">ClauseElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">_compiler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a compiler appropriate for this ClauseElement, given a</span>
<span class="sd">        Dialect.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">dialect</span><span class="o">.</span><span class="n">ddl_compiler</span><span class="p">(</span><span class="n">dialect</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DDLElement</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">Executable</span><span class="p">,</span> <span class="n">_DDLCompiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for DDL expression constructs.</span>

<span class="sd">    This class is the base for the general purpose :class:`.DDL` class,</span>
<span class="sd">    as well as the various create/drop clause constructs such as</span>
<span class="sd">    :class:`.CreateTable`, :class:`.DropTable`, :class:`.AddConstraint`,</span>
<span class="sd">    etc.</span>

<span class="sd">    :class:`.DDLElement` integrates closely with SQLAlchemy events,</span>
<span class="sd">    introduced in :ref:`event_toplevel`.  An instance of one is</span>
<span class="sd">    itself an event receiving callable::</span>

<span class="sd">        event.listen(</span>
<span class="sd">            users,</span>
<span class="sd">            &#39;after_create&#39;,</span>
<span class="sd">            AddConstraint(constraint).execute_if(dialect=&#39;postgresql&#39;)</span>
<span class="sd">        )</span>

<span class="sd">    See also:</span>

<span class="sd">        :class:`.DDL`</span>

<span class="sd">        :class:`.DDLEvents`</span>

<span class="sd">        :ref:`event_toplevel`</span>

<span class="sd">        :ref:`schema_ddl_sequences`</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_execution_options</span> <span class="o">=</span> <span class="n">expression</span><span class="o">.</span><span class="n">Executable</span><span class="o">.</span>\
                            <span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s">&#39;autocommit&#39;</span><span class="p">:</span> <span class="bp">True</span><span class="p">})</span>

    <span class="n">target</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">on</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">dialect</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">callable_</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute this DDL immediately.</span>

<span class="sd">        Executes the DDL statement in isolation using the supplied</span>
<span class="sd">        :class:`.Connectable` or</span>
<span class="sd">        :class:`.Connectable` assigned to the ``.bind``</span>
<span class="sd">        property, if not supplied. If the DDL has a conditional ``on``</span>
<span class="sd">        criteria, it will be invoked with None as the event.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          Optional, an ``Engine`` or ``Connection``. If not supplied, a valid</span>
<span class="sd">          :class:`.Connectable` must be present in the</span>
<span class="sd">          ``.bind`` property.</span>

<span class="sd">        :param target:</span>
<span class="sd">          Optional, defaults to None.  The target SchemaItem for the</span>
<span class="sd">          execute call.  Will be passed to the ``on`` callable if any,</span>
<span class="sd">          and may also provide string expansion data for the</span>
<span class="sd">          statement. See ``execute_at`` for more information.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">bind</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">bind</span> <span class="o">=</span> <span class="n">_bind_or_error</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_execute</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">against</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                        <span class="s">&quot;DDL execution skipped, criteria not met.&quot;</span><span class="p">)</span>

    <span class="nd">@util.deprecated</span><span class="p">(</span><span class="s">&quot;0.7&quot;</span><span class="p">,</span> <span class="s">&quot;See :class:`.DDLEvents`, as well as &quot;</span>
        <span class="s">&quot;:meth:`.DDLElement.execute_if`.&quot;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">execute_at</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Link execution of this DDL to the DDL lifecycle of a SchemaItem.</span>

<span class="sd">        Links this ``DDLElement`` to a ``Table`` or ``MetaData`` instance,</span>
<span class="sd">        executing it when that schema item is created or dropped. The DDL</span>
<span class="sd">        statement will be executed using the same Connection and transactional</span>
<span class="sd">        context as the Table create/drop itself. The ``.bind`` property of</span>
<span class="sd">        this statement is ignored.</span>

<span class="sd">        :param event:</span>
<span class="sd">          One of the events defined in the schema item&#39;s ``.ddl_events``;</span>
<span class="sd">          e.g. &#39;before-create&#39;, &#39;after-create&#39;, &#39;before-drop&#39; or &#39;after-drop&#39;</span>

<span class="sd">        :param target:</span>
<span class="sd">          The Table or MetaData instance for which this DDLElement will</span>
<span class="sd">          be associated with.</span>

<span class="sd">        A DDLElement instance can be linked to any number of schema items.</span>

<span class="sd">        ``execute_at`` builds on the ``append_ddl_listener`` interface of</span>
<span class="sd">        :class:`.MetaData` and :class:`.Table` objects.</span>

<span class="sd">        Caveat: Creating or dropping a Table in isolation will also trigger</span>
<span class="sd">        any DDL set to ``execute_at`` that Table&#39;s MetaData.  This may change</span>
<span class="sd">        in a future release.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">call_event</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_execute_deprecated</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span>
                                    <span class="n">target</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">against</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

        <span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="o">+</span> <span class="n">event_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">,</span> <span class="s">&#39;_&#39;</span><span class="p">),</span> <span class="n">call_event</span><span class="p">)</span>

    <span class="nd">@expression._generative</span>
    <span class="k">def</span> <span class="nf">against</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of this DDL against a specific schema item.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">target</span> <span class="o">=</span> <span class="n">target</span>

    <span class="nd">@expression._generative</span>
    <span class="k">def</span> <span class="nf">execute_if</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dialect</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">callable_</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a callable that will execute this</span>
<span class="sd">        DDLElement conditionally.</span>

<span class="sd">        Used to provide a wrapper for event listening::</span>

<span class="sd">            event.listen(</span>
<span class="sd">                        metadata,</span>
<span class="sd">                        &#39;before_create&#39;,</span>
<span class="sd">                        DDL(&quot;my_ddl&quot;).execute_if(dialect=&#39;postgresql&#39;)</span>
<span class="sd">                    )</span>

<span class="sd">        :param dialect: May be a string, tuple or a callable</span>
<span class="sd">          predicate.  If a string, it will be compared to the name of the</span>
<span class="sd">          executing database dialect::</span>

<span class="sd">            DDL(&#39;something&#39;).execute_if(dialect=&#39;postgresql&#39;)</span>

<span class="sd">          If a tuple, specifies multiple dialect names::</span>

<span class="sd">            DDL(&#39;something&#39;).execute_if(dialect=(&#39;postgresql&#39;, &#39;mysql&#39;))</span>

<span class="sd">        :param callable_: A callable, which will be invoked with</span>
<span class="sd">          four positional arguments as well as optional keyword</span>
<span class="sd">          arguments:</span>

<span class="sd">            :ddl:</span>
<span class="sd">              This DDL element.</span>

<span class="sd">            :target:</span>
<span class="sd">              The :class:`.Table` or :class:`.MetaData` object which is the</span>
<span class="sd">              target of this event. May be None if the DDL is executed</span>
<span class="sd">              explicitly.</span>

<span class="sd">            :bind:</span>
<span class="sd">              The :class:`.Connection` being used for DDL execution</span>

<span class="sd">            :tables:</span>
<span class="sd">              Optional keyword argument - a list of Table objects which are to</span>
<span class="sd">              be created/ dropped within a MetaData.create_all() or drop_all()</span>
<span class="sd">              method call.</span>

<span class="sd">            :state:</span>
<span class="sd">              Optional keyword argument - will be the ``state`` argument</span>
<span class="sd">              passed to this function.</span>

<span class="sd">            :checkfirst:</span>
<span class="sd">             Keyword argument, will be True if the &#39;checkfirst&#39; flag was</span>
<span class="sd">             set during the call to ``create()``, ``create_all()``,</span>
<span class="sd">             ``drop()``, ``drop_all()``.</span>

<span class="sd">          If the callable returns a true value, the DDL statement will be</span>
<span class="sd">          executed.</span>

<span class="sd">        :param state: any value which will be passed to the callable_</span>
<span class="sd">          as the ``state`` keyword argument.</span>

<span class="sd">        See also:</span>

<span class="sd">            :class:`.DDLEvents`</span>

<span class="sd">            :ref:`event_toplevel`</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">=</span> <span class="n">dialect</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span> <span class="o">=</span> <span class="n">callable_</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>

    <span class="k">def</span> <span class="nf">_should_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_execute_deprecated</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span> <span class="o">!=</span> <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dialect</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span> \
            <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">callable_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">def</span> <span class="nf">_should_execute_deprecated</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">==</span> <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">name</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the DDL as a ddl_listener.&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_should_execute</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">bind</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">bind</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">against</span><span class="p">(</span><span class="n">target</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_check_ddl_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">on</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span> <span class="ow">and</span>
            <span class="p">(</span><span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">on</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">set</span><span class="p">))</span> <span class="ow">and</span>
                    <span class="ow">not</span> <span class="n">util</span><span class="o">.</span><span class="n">callable</span><span class="p">(</span><span class="n">on</span><span class="p">))):</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Expected the name of a database dialect, a tuple &quot;</span>
                <span class="s">&quot;of names, or a callable for &quot;</span>
                <span class="s">&quot;&#39;on&#39; criteria, got type &#39;</span><span class="si">%s</span><span class="s">&#39;.&quot;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">(</span><span class="n">on</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span>

    <span class="k">def</span> <span class="nf">_set_bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bind</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">bind</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">bind</span><span class="p">,</span> <span class="n">_set_bind</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_generate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__new__</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">__class__</span><span class="p">)</span>
        <span class="n">s</span><span class="o">.</span><span class="n">__dict__</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">s</span>


<span class="k">class</span> <span class="nc">DDL</span><span class="p">(</span><span class="n">DDLElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A literal DDL statement.</span>

<span class="sd">    Specifies literal SQL DDL to be executed by the database.  DDL objects</span>
<span class="sd">    function as DDL event listeners, and can be subscribed to those events</span>
<span class="sd">    listed in :class:`.DDLEvents`, using either :class:`.Table` or</span>
<span class="sd">    :class:`.MetaData` objects as targets.   Basic templating support allows</span>
<span class="sd">    a single DDL instance to handle repetitive tasks for multiple tables.</span>

<span class="sd">    Examples::</span>

<span class="sd">      from sqlalchemy import event, DDL</span>

<span class="sd">      tbl = Table(&#39;users&#39;, metadata, Column(&#39;uid&#39;, Integer))</span>
<span class="sd">      event.listen(tbl, &#39;before_create&#39;, DDL(&#39;DROP TRIGGER users_trigger&#39;))</span>

<span class="sd">      spow = DDL(&#39;ALTER TABLE %(table)s SET secretpowers TRUE&#39;)</span>
<span class="sd">      event.listen(tbl, &#39;after_create&#39;, spow.execute_if(dialect=&#39;somedb&#39;))</span>

<span class="sd">      drop_spow = DDL(&#39;ALTER TABLE users SET secretpowers FALSE&#39;)</span>
<span class="sd">      connection.execute(drop_spow)</span>

<span class="sd">    When operating on Table events, the following ``statement``</span>
<span class="sd">    string substitions are available::</span>

<span class="sd">      %(table)s  - the Table name, with any required quoting applied</span>
<span class="sd">      %(schema)s - the schema name, with any required quoting applied</span>
<span class="sd">      %(fullname)s - the Table name including schema, quoted if needed</span>

<span class="sd">    The DDL&#39;s &quot;context&quot;, if any, will be combined with the standard</span>
<span class="sd">    substutions noted above.  Keys present in the context will override</span>
<span class="sd">    the standard substitutions.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;ddl&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">context</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a DDL statement.</span>

<span class="sd">        :param statement:</span>
<span class="sd">          A string or unicode string to be executed.  Statements will be</span>
<span class="sd">          processed with Python&#39;s string formatting operator.  See the</span>
<span class="sd">          ``context`` argument and the ``execute_at`` method.</span>

<span class="sd">          A literal &#39;%&#39; in a statement must be escaped as &#39;%%&#39;.</span>

<span class="sd">          SQL bind parameters are not available in DDL statements.</span>

<span class="sd">        :param on:</span>
<span class="sd">          Deprecated.  See :meth:`.DDLElement.execute_if`.</span>

<span class="sd">          Optional filtering criteria.  May be a string, tuple or a callable</span>
<span class="sd">          predicate.  If a string, it will be compared to the name of the</span>
<span class="sd">          executing database dialect::</span>

<span class="sd">            DDL(&#39;something&#39;, on=&#39;postgresql&#39;)</span>

<span class="sd">          If a tuple, specifies multiple dialect names::</span>

<span class="sd">            DDL(&#39;something&#39;, on=(&#39;postgresql&#39;, &#39;mysql&#39;))</span>

<span class="sd">          If a callable, it will be invoked with four positional arguments</span>
<span class="sd">          as well as optional keyword arguments:</span>

<span class="sd">            :ddl:</span>
<span class="sd">              This DDL element.</span>

<span class="sd">            :event:</span>
<span class="sd">              The name of the event that has triggered this DDL, such as</span>
<span class="sd">              &#39;after-create&#39; Will be None if the DDL is executed explicitly.</span>

<span class="sd">            :target:</span>
<span class="sd">              The ``Table`` or ``MetaData`` object which is the target of</span>
<span class="sd">              this event. May be None if the DDL is executed explicitly.</span>

<span class="sd">            :connection:</span>
<span class="sd">              The ``Connection`` being used for DDL execution</span>

<span class="sd">            :tables:</span>
<span class="sd">              Optional keyword argument - a list of Table objects which are to</span>
<span class="sd">              be created/ dropped within a MetaData.create_all() or drop_all()</span>
<span class="sd">              method call.</span>


<span class="sd">          If the callable returns a true value, the DDL statement will be</span>
<span class="sd">          executed.</span>

<span class="sd">        :param context:</span>
<span class="sd">          Optional dictionary, defaults to None.  These values will be</span>
<span class="sd">          available for use in string substitutions on the DDL statement.</span>

<span class="sd">        :param bind:</span>
<span class="sd">          Optional. A :class:`.Connectable`, used by</span>
<span class="sd">          default when ``execute()`` is invoked without a bind argument.</span>


<span class="sd">        See also:</span>

<span class="sd">            :class:`.DDLEvents`</span>
<span class="sd">            :mod:`sqlalchemy.event`</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">statement</span><span class="p">,</span> <span class="nb">basestring</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
                <span class="s">&quot;Expected a string or unicode SQL statement, got &#39;</span><span class="si">%r</span><span class="s">&#39;&quot;</span> <span class="o">%</span>
                <span class="n">statement</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">statement</span> <span class="o">=</span> <span class="n">statement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="n">context</span> <span class="ow">or</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_check_ddl_on</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_bind</span> <span class="o">=</span> <span class="n">bind</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s">&#39;&lt;</span><span class="si">%s</span><span class="s">@</span><span class="si">%s</span><span class="s">; </span><span class="si">%s</span><span class="s">&gt;&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__name__</span><span class="p">,</span> <span class="nb">id</span><span class="p">(</span><span class="bp">self</span><span class="p">),</span>
            <span class="s">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="nb">repr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">statement</span><span class="p">)]</span> <span class="o">+</span>
                      <span class="p">[</span><span class="s">&#39;</span><span class="si">%s</span><span class="s">=</span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">))</span>
                       <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s">&#39;on&#39;</span><span class="p">,</span> <span class="s">&#39;context&#39;</span><span class="p">)</span>
                       <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">)]))</span>


<span class="k">def</span> <span class="nf">_to_schema_column</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s">&#39;__clause_element__&#39;</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="s">&quot;schema.Column object expected&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">element</span>


<span class="k">def</span> <span class="nf">_to_schema_column_or_string</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="s">&#39;__clause_element__&#39;</span><span class="p">):</span>
        <span class="n">element</span> <span class="o">=</span> <span class="n">element</span><span class="o">.</span><span class="n">__clause_element__</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="p">(</span><span class="nb">basestring</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">)):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;Element </span><span class="si">%r</span><span class="s"> is not a string name or column element&quot;</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">element</span>


<span class="k">class</span> <span class="nc">_CreateDropBase</span><span class="p">(</span><span class="n">DDLElement</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for DDL constucts that represent CREATE and DROP or</span>
<span class="sd">    equivalents.</span>

<span class="sd">    The common theme of _CreateDropBase is a single</span>
<span class="sd">    ``element`` attribute which refers to the element</span>
<span class="sd">    to be created or dropped.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_ddl_on</span><span class="p">(</span><span class="n">on</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">on</span> <span class="o">=</span> <span class="n">on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bind</span> <span class="o">=</span> <span class="n">bind</span>

    <span class="k">def</span> <span class="nf">_create_rule_disable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">compiler</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Allow disable of _create_rule using a callable.</span>

<span class="sd">        Pass to _create_rule using</span>
<span class="sd">        util.portable_instancemethod(self._create_rule_disable)</span>
<span class="sd">        to retain serializability.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">False</span>


<span class="k">class</span> <span class="nc">CreateSchema</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a CREATE SCHEMA statement.</span>

<span class="sd">    .. versionadded:: 0.7.4</span>

<span class="sd">    The argument here is the string name of the schema.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;create_schema&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new :class:`.CreateSchema` construct.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CreateSchema</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DropSchema</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a DROP SCHEMA statement.</span>

<span class="sd">    The argument here is the string name of the schema.</span>

<span class="sd">    .. versionadded:: 0.7.4</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_schema&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">quote</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a new :class:`.DropSchema` construct.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">quote</span> <span class="o">=</span> <span class="n">quote</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">cascade</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DropSchema</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">CreateTable</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a CREATE TABLE statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;create_table&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create a :class:`.CreateTable` construct.</span>

<span class="sd">        :param element: a :class:`.Table` that&#39;s the subject</span>
<span class="sd">         of the CREATE</span>
<span class="sd">        :param on: See the description for &#39;on&#39; in :class:`.DDL`.</span>
<span class="sd">        :param bind: See the description for &#39;bind&#39; in :class:`.DDL`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">on</span><span class="p">,</span> <span class="n">bind</span><span class="o">=</span><span class="n">bind</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">CreateColumn</span><span class="p">(</span><span class="n">column</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">column</span> <span class="ow">in</span> <span class="n">element</span><span class="o">.</span><span class="n">columns</span>
        <span class="p">]</span>


<span class="k">class</span> <span class="nc">_DropView</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Semi-public &#39;DROP VIEW&#39; construct.</span>

<span class="sd">    Used by the test suite for dialect-agnostic drops of views.</span>
<span class="sd">    This object will eventually be part of a public &quot;view&quot; API.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_view&quot;</span>


<span class="k">class</span> <span class="nc">CreateColumn</span><span class="p">(</span><span class="n">_DDLCompiles</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a :class:`.Column` as rendered in a CREATE TABLE statement,</span>
<span class="sd">    via the :class:`.CreateTable` construct.</span>

<span class="sd">    This is provided to support custom column DDL within the generation</span>
<span class="sd">    of CREATE TABLE statements, by using the</span>
<span class="sd">    compiler extension documented in :ref:`sqlalchemy.ext.compiler_toplevel`</span>
<span class="sd">    to extend :class:`.CreateColumn`.</span>

<span class="sd">    Typical integration is to examine the incoming :class:`.Column`</span>
<span class="sd">    object, and to redirect compilation if a particular flag or condition</span>
<span class="sd">    is found::</span>

<span class="sd">        from sqlalchemy import schema</span>
<span class="sd">        from sqlalchemy.ext.compiler import compiles</span>

<span class="sd">        @compiles(schema.CreateColumn)</span>
<span class="sd">        def compile(element, compiler, **kw):</span>
<span class="sd">            column = element.element</span>

<span class="sd">            if &quot;special&quot; not in column.info:</span>
<span class="sd">                return compiler.visit_create_column(element, **kw)</span>

<span class="sd">            text = &quot;%s SPECIAL DIRECTIVE %s&quot; % (</span>
<span class="sd">                    column.name,</span>
<span class="sd">                    compiler.type_compiler.process(column.type)</span>
<span class="sd">                )</span>
<span class="sd">            default = compiler.get_column_default_string(column)</span>
<span class="sd">            if default is not None:</span>
<span class="sd">                text += &quot; DEFAULT &quot; + default</span>

<span class="sd">            if not column.nullable:</span>
<span class="sd">                text += &quot; NOT NULL&quot;</span>

<span class="sd">            if column.constraints:</span>
<span class="sd">                text += &quot; &quot;.join(</span>
<span class="sd">                            compiler.process(const)</span>
<span class="sd">                            for const in column.constraints)</span>
<span class="sd">            return text</span>

<span class="sd">    The above construct can be applied to a :class:`.Table` as follows::</span>

<span class="sd">        from sqlalchemy import Table, Metadata, Column, Integer, String</span>
<span class="sd">        from sqlalchemy import schema</span>

<span class="sd">        metadata = MetaData()</span>

<span class="sd">        table = Table(&#39;mytable&#39;, MetaData(),</span>
<span class="sd">                Column(&#39;x&#39;, Integer, info={&quot;special&quot;:True}, primary_key=True),</span>
<span class="sd">                Column(&#39;y&#39;, String(50)),</span>
<span class="sd">                Column(&#39;z&#39;, String(20), info={&quot;special&quot;:True})</span>
<span class="sd">            )</span>

<span class="sd">        metadata.create_all(conn)</span>

<span class="sd">    Above, the directives we&#39;ve added to the :attr:`.Column.info` collection</span>
<span class="sd">    will be detected by our custom compilation scheme::</span>

<span class="sd">        CREATE TABLE mytable (</span>
<span class="sd">                x SPECIAL DIRECTIVE INTEGER NOT NULL,</span>
<span class="sd">                y VARCHAR(50),</span>
<span class="sd">                z SPECIAL DIRECTIVE VARCHAR(20),</span>
<span class="sd">            PRIMARY KEY (x)</span>
<span class="sd">        )</span>

<span class="sd">    .. versionadded:: 0.8 The :class:`.CreateColumn` construct was added</span>
<span class="sd">       to support custom column creation styles.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&#39;create_column&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">element</span> <span class="o">=</span> <span class="n">element</span>


<span class="k">class</span> <span class="nc">DropTable</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a DROP TABLE statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_table&quot;</span>


<span class="k">class</span> <span class="nc">CreateSequence</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a CREATE SEQUENCE statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;create_sequence&quot;</span>


<span class="k">class</span> <span class="nc">DropSequence</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a DROP SEQUENCE statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_sequence&quot;</span>


<span class="k">class</span> <span class="nc">CreateIndex</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a CREATE INDEX statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;create_index&quot;</span>


<span class="k">class</span> <span class="nc">DropIndex</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent a DROP INDEX statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_index&quot;</span>


<span class="k">class</span> <span class="nc">AddConstraint</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent an ALTER TABLE ADD CONSTRAINT statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;add_constraint&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">AddConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">element</span><span class="o">.</span><span class="n">_create_rule</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">portable_instancemethod</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_create_rule_disable</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">DropConstraint</span><span class="p">(</span><span class="n">_CreateDropBase</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Represent an ALTER TABLE DROP CONSTRAINT statement.&quot;&quot;&quot;</span>

    <span class="n">__visit_name__</span> <span class="o">=</span> <span class="s">&quot;drop_constraint&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">element</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cascade</span> <span class="o">=</span> <span class="n">cascade</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DropConstraint</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>
        <span class="n">element</span><span class="o">.</span><span class="n">_create_rule</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">portable_instancemethod</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_create_rule_disable</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_bind_or_error</span><span class="p">(</span><span class="n">schemaitem</span><span class="p">,</span> <span class="n">msg</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="n">bind</span> <span class="o">=</span> <span class="n">schemaitem</span><span class="o">.</span><span class="n">bind</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">bind</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">schemaitem</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span>
        <span class="n">label</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">schemaitem</span><span class="p">,</span> <span class="s">&#39;fullname&#39;</span><span class="p">,</span>
                        <span class="nb">getattr</span><span class="p">(</span><span class="n">schemaitem</span><span class="p">,</span> <span class="s">&#39;name&#39;</span><span class="p">,</span> <span class="bp">None</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="s">&#39;</span><span class="si">%s</span><span class="s"> </span><span class="si">%r</span><span class="s">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">schemaitem</span><span class="p">,</span> <span class="p">(</span><span class="n">MetaData</span><span class="p">,</span> <span class="n">DDL</span><span class="p">)):</span>
            <span class="n">bindable</span> <span class="o">=</span> <span class="s">&quot;the </span><span class="si">%s</span><span class="s">&#39;s .bind&quot;</span> <span class="o">%</span> <span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">bindable</span> <span class="o">=</span> <span class="s">&quot;this </span><span class="si">%s</span><span class="s">&#39;s .metadata.bind&quot;</span> <span class="o">%</span> <span class="n">name</span>

        <span class="k">if</span> <span class="n">msg</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;The </span><span class="si">%s</span><span class="s"> is not bound to an Engine or Connection.  &quot;</span>\
                   <span class="s">&quot;Execution can not proceed without a database to execute &quot;</span>\
                   <span class="s">&quot;against.  Either execute with an explicit connection or &quot;</span>\
                   <span class="s">&quot;assign </span><span class="si">%s</span><span class="s"> to enable implicit execution.&quot;</span> <span class="o">%</span> \
                   <span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">bindable</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">UnboundExecutionError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bind</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="../../np-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">pele 0.1 documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2012, Victor Rhle, Jacob Stevenson.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>